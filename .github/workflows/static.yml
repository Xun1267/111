<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨æƒ…å¢ƒé£é™©å†³ç­–çš„ä¸ªæ€§åŒ–åŠ¨æ€è¯„ä¼°æµ‹éªŒ - è´å¶æ–¯å››å‚æ•°åˆ†æç‰ˆ</title>
    
    <!-- å¤šCDNå¤‡é€‰æ–¹æ¡ˆ -->
    <script src="https://unpkg.com/jspsych@7.3.4" 
            onerror="loadFromBackupCDN(this, 'jspsych')"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3" 
            onerror="loadFromBackupCDN(this, 'plugin-html-keyboard-response')"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3" 
            onerror="loadFromBackupCDN(this, 'plugin-html-button-response')"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3" 
            onerror="loadFromBackupCDN(this, 'plugin-instructions')"></script>
    
    <!-- CSS -->
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" 
          rel="stylesheet" type="text/css" onerror="loadBackupCSS()" />
    
    <style>
        /* åŸºç¡€æ ·å¼ */
        .jspsych-display-element {
            background: #f8f9fa;
            color: #333;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        
        /* å®éªŒå®¹å™¨ */
        .experiment-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
        }
        
        /* æƒ…å¢ƒæ ‡è¯† */
        .scenario-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .scenario-medical { background: linear-gradient(135deg, #e8f5e8, #c8e6c9); color: #2e7d32; }
        .scenario-social { background: linear-gradient(135deg, #fff3e0, #ffcc80); color: #ef6c00; }
        .scenario-economic { background: linear-gradient(135deg, #e3f2fd, #90caf9); color: #1565c0; }
        
        /* åŒ»ç–—æƒ…å¢ƒæ ·å¼ */
        .health-status {
            text-align: center;
            margin: 25px 0;
        }
        
        .health-bar-container {
            width: 100%;
            max-width: 450px;
            margin: 20px auto;
            background: #e9ecef;
            border-radius: 25px;
            overflow: hidden;
            height: 35px;
            border: 3px solid #dee2e6;
            position: relative;
        }
        
        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.4s ease, background-color 0.3s ease;
            border-radius: 22px;
            position: relative;
        }
        
        .health-bar.side-effect {
            background: #dc3545 !important;
            animation: shake 0.6s ease-in-out;
        }
        
        .intensity-scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 450px;
            margin: 20px auto;
            padding: 15px 0;
        }
        
        .intensity-marker {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #dee2e6;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .intensity-marker.active {
            background: #28a745;
            transform: scale(1.8);
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
        }
        
        /* ç¤¾ä¼šæƒ…å¢ƒæ ·å¼ */
        .region-map {
            width: 100%;
            max-width: 500px;
            height: 300px;
            margin: 20px auto;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 3px solid #6c757d;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .region-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        .region-map.unrest {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-color: #f44336;
            animation: regionShake 0.5s ease-in-out;
        }
        
        .resource-bars {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .resource-bar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .resource-bar.depleted {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        
        /* ç»æµæƒ…å¢ƒæ ·å¼ */
        .asset-info {
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e8, #f3e5f5);
            border-radius: 15px;
            border: 2px solid #9c27b0;
            animation: priceRise 0.5s ease-out;
        }
        
        .price-chart {
            width: 100%;
            max-width: 500px;
            height: 200px;
            margin: 20px auto;
            background: #ffffff;
            border: 2px solid #1976d2;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* ç»Ÿè®¡é¢æ¿ */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1976d2;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .experiment-btn {
            padding: 18px 35px;
            font-size: 17px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 220px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .risk-btn {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
        }
        
        .risk-btn:hover {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }
        
        .safe-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        
        .safe-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        /* åé¦ˆæ¶ˆæ¯ */
        .feedback-message {
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            text-align: center;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .negative-feedback {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 3px solid #f44336;
            color: #c62828;
        }
        
        .positive-feedback {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border: 3px solid #4caf50;
            color: #2e7d32;
        }
        
        /* æƒ…å¢ƒè½¬æ¢æç¤º */
        .scenario-transition {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 3px solid #1976d2;
            color: #0d47a1;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        @keyframes regionShake {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes crashFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes drawPath {
            0% { 
                stroke-dasharray: 1000;
                stroke-dashoffset: 1000;
            }
            100% { 
                stroke-dasharray: 1000;
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes priceRise {
            0% { transform: translateY(10px); opacity: 0.7; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        /* æƒ…å¢ƒé€‰æ‹©æ ·å¼ */
        .scenario-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin: 30px 0;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .scenario-card {
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .scenario-icon {
            transition: all 0.3s ease;
        }
        
        .scenario-card:hover .scenario-icon {
            transform: scale(1.1);
        }
        
        .select-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .scenario-card:hover .select-btn {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 10px auto;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            transition: width 0.3s ease;
        }
        
        /* è´å¶æ–¯å‚æ•°åˆ†æç»“æœæ ·å¼ */
        .bayesian-results {
            background: linear-gradient(135deg, #f3e5f5, #e1f5fe);
            border: 3px solid #9c27b0;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .parameter-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .parameter-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
            margin: 10px 0;
        }
        
        .parameter-interpretation {
            background: #fff8e1;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        /* åŠ è½½å’Œé”™è¯¯å¤„ç†æ ·å¼ */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-container {
            background: #ffebee;
            border: 3px solid #f44336;
            border-radius: 15px;
            padding: 30px;
            margin: 20px;
            max-width: 600px;
            text-align: center;
        }
        
        .retry-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .retry-btn:hover {
            background: #1565c0;
        }
        
        /* ç»“æœé¡µé¢æ ·å¼ */
        .results-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 50px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        
        .result-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .result-value {
            font-size: 32px;
            font-weight: bold;
            color: #1976d2;
            margin: 15px 0;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            border: none;
            padding: 18px 35px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .download-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
        }
        
        .restart-btn {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border: none;
            padding: 18px 35px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }
        
        .restart-btn:hover {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.5);
        }
    </style>
    
    <!-- CDNå¤‡é€‰è„šæœ¬ -->
    <script>
        const CDN_ALTERNATIVES = {
            jspsych: [
                'https://unpkg.com/jspsych@7.3.4',
                'https://cdn.jsdelivr.net/npm/jspsych@7.3.4'
            ],
            'plugin-html-keyboard-response': [
                'https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3',
                'https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-keyboard-response@1.1.3'
            ],
            'plugin-html-button-response': [
                'https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3',
                'https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-button-response@1.1.3'
            ],
            'plugin-instructions': [
                'https://unpkg.com/@jspsych/plugin-instructions@1.1.3',
                'https://cdn.jsdelivr.net/npm/@jspsych/plugin-instructions@1.1.3'
            ]
        };
        
        let cdnRetryCount = {};
        
        function loadFromBackupCDN(failedElement, packageName) {
            if (!cdnRetryCount[packageName]) {
                cdnRetryCount[packageName] = 0;
            }
            
            const alternatives = CDN_ALTERNATIVES[packageName];
            cdnRetryCount[packageName]++;
            
            if (cdnRetryCount[packageName] < alternatives.length) {
                const newScript = document.createElement('script');
                newScript.src = alternatives[cdnRetryCount[packageName]];
                newScript.onerror = () => loadFromBackupCDN(newScript, packageName);
                failedElement.parentNode.replaceChild(newScript, failedElement);
            } else {
                console.error(`æ‰€æœ‰CDNå¤‡é€‰éƒ½å¤±è´¥äº†: ${packageName}`);
                showError(`æ— æ³•åŠ è½½${packageName}`);
            }
        }
        
        function loadBackupCSS() {
            const backupCSS = document.createElement('link');
            backupCSS.href = 'https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css';
            backupCSS.rel = 'stylesheet';
            backupCSS.type = 'text/css';
            document.head.appendChild(backupCSS);
        }
        
        function showError(message) {
            document.body.innerHTML = `
                <div class="loading-container">
                    <div class="error-container">
                        <h2>âš ï¸ åŠ è½½å¤±è´¥</h2>
                        <p>é”™è¯¯: ${message}</p>
                        <button class="retry-btn" onclick="location.reload()">é‡æ–°åŠ è½½</button>
                    </div>
                </div>
            `;
        }
    </script>
</head>

<body>
    <div id="loading-indicator" class="loading-container">
        <div class="loading-spinner"></div>
        <div>æ­£åœ¨åŠ è½½è·¨æƒ…å¢ƒé£é™©å†³ç­–æµ‹éªŒ...</div>
        <div id="loading-status" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
    </div>
    
    <div id="jspsych-target" style="display: none;"></div>

    <script>
        // å…¨å±€å˜é‡
        let participantId = 'P' + Math.random().toString(36).substr(2, 9);
        const TRIALS_PER_SCENARIO = 50; // æ¯ä¸ªæƒ…å¢ƒ50è¯•æ¬¡
        let allExperimentData = [];
        let currentScenario = '';
        let currentTrial = 0;
        let currentRiskLevel = 0;
        let currentPoints = 0;
        
        // ä¿®æ”¹ï¼šä¸ºæ¯ä¸ªæƒ…å¢ƒå•ç‹¬ç»´æŠ¤ç´¯è®¡ç‚¹æ•°
        let scenarioPoints = {
            'PTC': 0,      // åŒ»ç–—æƒ…å¢ƒç´¯è®¡ç‚¹æ•°
            'WRRD': 0,     // ç¤¾ä¼šæƒ…å¢ƒç´¯è®¡ç‚¹æ•°
            'MID': 0       // ç»æµæƒ…å¢ƒç´¯è®¡ç‚¹æ•°
        };
        
        let availableScenarios = ['PTC', 'WRRD', 'MID']; // å¯é€‰æ‹©çš„æƒ…å¢ƒ
        let completedScenarios = []; // å·²å®Œæˆçš„æƒ…å¢ƒ
        let scenarioStartTime = null;
        
        // ç”¨äºè´å¶æ–¯å‚æ•°ä¼°è®¡çš„æ•°æ®
        let bayesianData = {};
        
        // èµ„äº§åç§°æ± ï¼ˆç”¨äºç»æµæƒ…å¢ƒï¼‰
        const assetNames = [
            'TechCoin', 'BioStock', 'GreenEnergy', 'AI-Token', 'MetaShare', 
            'CryptoGold', 'QuantumBit', 'NanoTech', 'SpaceX-Like', 'BlockChain+'
        ];
        
        // åœ°åŒºåç§°æ± ï¼ˆç”¨äºç¤¾ä¼šæƒ…å¢ƒï¼‰
        const regionNames = [
            'é’å±±åŒº', 'ä¸œæ¹–åŒº', 'è¥¿åŸåŒº', 'å—é—¨åŒº', 'åŒ—å…³åŒº', 'ä¸­å¤®åŒº', 'æ¸¯å£åŒº', 'å·¥ä¸šåŒº',
            'æ–°åŸåŒº', 'è€åŸåŒº', 'å¼€å‘åŒº', 'ç§‘æŠ€åŒº', 'å•†è´¸åŒº', 'æ–‡æ•™åŒº', 'å†œä¸šåŒº', 'å±±åŒº',
            'æ²³ä¸œåŒº', 'æ²³è¥¿åŒº', 'é«˜æ–°åŒº', 'ç»å¼€åŒº'
        ];
        
        // =================
        // è´å¶æ–¯å››å‚æ•°æ¨¡å‹å®ç°
        // =================
        
        class BayesianBARTModel {
            constructor() {
                this.maxBalloonSize = 12; // æ°”çƒæœ€å¤§å°ºå¯¸
                this.paramBounds = {
                    phi: [0.1, 0.99],    // å…ˆéªŒä¿¡å¿µ Î¦
                    eta: [0.01, 5.0],    // å­¦ä¹ ç‡ Î·  
                    gamma: [0.1, 5.0],   // é£é™©åå¥½ Î³
                    beta: [0.1, 10.0]    // å†³ç­–ä¸€è‡´æ€§ Î²
                };
            }
            
            // è®¡ç®—æ°”çƒçˆ†ç‚¸æ¦‚ç‡ p^burst = 1/(x - n^pumps)
            calculateBurstProbability(pumps) {
                return 1.0 / (this.maxBalloonSize - pumps);
            }
            
            // è®¡ç®—å†³ç­–è€…ä¿¡å¿µ p_k^belief
            calculateBelief(phi, eta, trialHistory, currentTrial) {
                let totalPumps = 0;
                let totalSuccess = 0;
                
                // ç´¯ç§¯åˆ°å½“å‰è¯•æ¬¡çš„å†å²æ•°æ®
                for (let i = 0; i < currentTrial; i++) {
                    if (trialHistory[i]) {
                        if (trialHistory[i].outcome === 'cash_out') {
                            totalSuccess += trialHistory[i].final_pumps;
                        }
                        totalPumps += trialHistory[i].final_pumps;
                    }
                }
                
                // è´å¶æ–¯æ›´æ–°å…¬å¼
                const numerator = phi + eta * totalSuccess;
                const denominator = 1 + eta * totalPumps;
                const beliefProb = 1 - (numerator / denominator);
                
                return Math.max(0.001, Math.min(0.999, beliefProb));
            }
            
            // è®¡ç®—æœ€ä¼˜å……æ°”æ¬¡æ•° Ï‰_k = -Î³/log(1 - p_k^belief)
            calculateOptimalPumps(gamma, belief) {
                const logTerm = Math.log(1 - belief);
                if (logTerm >= 0) return 1; // é¿å…é™¤ä»¥é›¶æˆ–è´Ÿæ•°
                return Math.max(1, -gamma / logTerm);
            }
            
            // è®¡ç®—å……æ°”è¡Œä¸ºæ¦‚ç‡ p_kl^pump = 1/(1 + e^(Î²Ã—(l - Ï‰_k)))
            calculatePumpProbability(beta, currentPumps, optimalPumps) {
                const exponent = beta * (currentPumps - optimalPumps);
                return 1.0 / (1.0 + Math.exp(exponent));
            }
            
            // è®¡ç®—å¯¹æ•°ä¼¼ç„¶å‡½æ•°
            calculateLogLikelihood(params, behaviorData) {
                const { phi, eta, gamma, beta } = params;
                let logLikelihood = 0;
                
                for (let trial = 0; trial < behaviorData.length; trial++) {
                    const trialData = behaviorData[trial];
                    if (!trialData || !trialData.actions) continue;
                    
                    // è®¡ç®—è¯¥è¯•æ¬¡çš„ä¿¡å¿µ
                    const belief = this.calculateBelief(phi, eta, behaviorData, trial);
                    const optimalPumps = this.calculateOptimalPumps(gamma, belief);
                    
                    // å¯¹è¯¥è¯•æ¬¡çš„æ¯ä¸ªåŠ¨ä½œè®¡ç®—ä¼¼ç„¶
                    for (let actionIdx = 0; actionIdx < trialData.actions.length; actionIdx++) {
                        const action = trialData.actions[actionIdx];
                        const currentPumps = actionIdx + 1;
                        
                        const pumpProb = this.calculatePumpProbability(beta, currentPumps, optimalPumps);
                        
                        if (action.action_type === 'risk') {
                            // é€‰æ‹©å……æ°”
                            logLikelihood += Math.log(Math.max(0.001, pumpProb));
                        } else if (action.action_type === 'cash_out') {
                            // é€‰æ‹©å…‘ç°
                            logLikelihood += Math.log(Math.max(0.001, 1 - pumpProb));
                            break; // å…‘ç°åè¯¥è¯•æ¬¡ç»“æŸ
                        }
                    }
                }
                
                return logLikelihood;
            }
            
            // ç®€åŒ–çš„ç½‘æ ¼æœç´¢å‚æ•°ä¼°è®¡
            estimateParameters(behaviorData, scenario) {
                console.log(`å¼€å§‹ä¼°è®¡${scenario}æƒ…å¢ƒçš„è´å¶æ–¯å‚æ•°...`);
                
                let bestParams = null;
                let bestLogLikelihood = -Infinity;
                
                // ç½‘æ ¼æœç´¢å‚æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
                const phiValues = [0.3, 0.5, 0.7, 0.85, 0.95];
                const etaValues = [0.1, 0.5, 1.0, 2.0];
                const gammaValues = [0.5, 1.0, 2.0, 3.0];
                const betaValues = [0.5, 1.0, 2.0, 5.0];
                
                let searchCount = 0;
                const totalSearches = phiValues.length * etaValues.length * gammaValues.length * betaValues.length;
                
                for (const phi of phiValues) {
                    for (const eta of etaValues) {
                        for (const gamma of gammaValues) {
                            for (const beta of betaValues) {
                                searchCount++;
                                
                                const params = { phi, eta, gamma, beta };
                                const logLikelihood = this.calculateLogLikelihood(params, behaviorData);
                                
                                if (logLikelihood > bestLogLikelihood) {
                                    bestLogLikelihood = logLikelihood;
                                    bestParams = { ...params };
                                }
                                
                                // æ˜¾ç¤ºè¿›åº¦
                                if (searchCount % 20 === 0) {
                                    console.log(`å‚æ•°æœç´¢è¿›åº¦: ${((searchCount / totalSearches) * 100).toFixed(1)}%`);
                                }
                            }
                        }
                    }
                }
                
                console.log(`${scenario}æƒ…å¢ƒå‚æ•°ä¼°è®¡å®Œæˆï¼Œæœ€ä½³å¯¹æ•°ä¼¼ç„¶: ${bestLogLikelihood.toFixed(4)}`);
                return {
                    parameters: bestParams,
                    logLikelihood: bestLogLikelihood,
                    converged: true
                };
            }
            
            // è§£é‡Šå‚æ•°å«ä¹‰
            interpretParameters(params, scenario) {
                const { phi, eta, gamma, beta } = params;
                
                const interpretation = {
                    phi: {
                        value: phi,
                        level: phi > 0.8 ? 'é«˜' : phi > 0.6 ? 'ä¸­' : 'ä½',
                        meaning: phi > 0.8 ? 'éå¸¸ä¹è§‚ï¼Œè®¤ä¸ºé£é™©å¾ˆå°‘å‘ç”Ÿ' : 
                                phi > 0.6 ? 'è¾ƒä¸ºä¹è§‚ï¼Œå¯¹é£é™©æœ‰ä¸€å®šè­¦è§‰' : 'è¾ƒä¸ºæ‚²è§‚ï¼Œé«˜ä¼°é£é™©æ¦‚ç‡'
                    },
                    eta: {
                        value: eta,
                        level: eta > 1.5 ? 'å¿«' : eta > 0.8 ? 'ä¸­' : 'æ…¢',
                        meaning: eta > 1.5 ? 'å­¦ä¹ é€Ÿåº¦å¿«ï¼Œèƒ½å¿«é€Ÿæ ¹æ®åé¦ˆè°ƒæ•´ç­–ç•¥' :
                                eta > 0.8 ? 'å­¦ä¹ é€Ÿåº¦é€‚ä¸­ï¼Œé€æ­¥æ ¹æ®ç»éªŒè°ƒæ•´' : 'å­¦ä¹ é€Ÿåº¦æ…¢ï¼Œæ›´ä¾èµ–åˆå§‹åˆ¤æ–­'
                    },
                    gamma: {
                        value: gamma,
                        level: gamma > 2.0 ? 'é«˜' : gamma > 1.2 ? 'ä¸­' : 'ä½',
                        meaning: gamma > 2.0 ? 'é£é™©åå¥½å¼ºï¼Œè¿½æ±‚é«˜æ”¶ç›Š' :
                                gamma > 1.2 ? 'é£é™©åå¥½é€‚ä¸­ï¼Œå¹³è¡¡æ”¶ç›Šä¸é£é™©' : 'é£é™©åŒæ¶ï¼Œåå¥½å®‰å…¨é€‰æ‹©'
                    },
                    beta: {
                        value: beta,
                        level: beta > 3.0 ? 'é«˜' : beta > 1.5 ? 'ä¸­' : 'ä½',
                        meaning: beta > 3.0 ? 'å†³ç­–éå¸¸ä¸€è‡´ï¼Œä¸¥æ ¼æŒ‰è®¡åˆ’æ‰§è¡Œ' :
                                beta > 1.5 ? 'å†³ç­–è¾ƒä¸ºä¸€è‡´ï¼Œå¶æœ‰éšæœºæ€§' : 'å†³ç­–éšæœºæ€§å¼ºï¼Œæ˜“å—æƒ…ç»ªå½±å“'
                    }
                };
                
                return interpretation;
            }
        }
        
        // å…¨å±€è´å¶æ–¯æ¨¡å‹å®ä¾‹
        const bayesianModel = new BayesianBARTModel();
        
        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loading-status');
            if (statusEl) statusEl.textContent = message;
        }
        
        // æ£€æŸ¥åº“åŠ è½½çŠ¶æ€
        function checkLibrariesLoaded() {
            updateLoadingStatus('æ£€æŸ¥jsPsychåº“...');
            
            if (typeof initJsPsych === 'undefined') {
                setTimeout(checkLibrariesLoaded, 500);
                return;
            }
            
            if (typeof jsPsychHtmlButtonResponse === 'undefined' || 
                typeof jsPsychInstructions === 'undefined') {
                setTimeout(checkLibrariesLoaded, 500);
                return;
            }
            
            initializeExperiment();
        }
        
        // é£é™©å‡½æ•°ï¼ˆé€šç”¨BARTèŒƒå¼ï¼‰
        function calculateRiskProbability(level, scenario) {
            let baseRisk;
            switch(scenario) {
                case 'PTC': // åŒ»ç–—ï¼šè¾ƒä¸ºä¿å®ˆçš„é£é™©å¢é•¿
                    if (level <= 2) baseRisk = 0.01;
                    else if (level <= 5) baseRisk = 0.03 + (level - 2) * 0.05;
                    else baseRisk = 0.18 + (level - 5) * 0.12;
                    break;
                case 'WRRD': // ç¤¾ä¼šï¼šä¸­ç­‰é£é™©å¢é•¿
                    if (level <= 2) baseRisk = 0.05;
                    else if (level <= 5) baseRisk = 0.1 + (level - 2) * 0.08;
                    else baseRisk = 0.34 + (level - 5) * 0.15;
                    break;
                case 'MID': // ç»æµï¼šæ¿€è¿›çš„é£é™©å¢é•¿ï¼ˆæ¨¡æ‹Ÿé‡‘èå¸‚åœºï¼‰
                    if (level <= 2) baseRisk = 0.02;
                    else if (level <= 4) baseRisk = 0.05 + (level - 2) * 0.07;
                    else baseRisk = 0.19 + (level - 4) * 0.18;
                    break;
                default:
                    baseRisk = 0.1;
            }
            return Math.min(baseRisk, 0.95); // ä¸Šé™95%
        }
        
        // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿè´Ÿé¢äº‹ä»¶
        function checkNegativeOutcome(level, scenario) {
            const probability = calculateRiskProbability(level, scenario);
            return Math.random() < probability;
        }
        
        // ä¿®æ”¹ï¼šè®°å½•è¯•æ¬¡æ•°æ®ï¼Œç¡®ä¿æ¯ä¸ªè¯•æ¬¡éƒ½è¢«è®°å½•
        function recordTrialData(scenario, trial, actions, outcome, finalLevel, lockedPoints, lostPoints) {
            const trialData = {
                participant_id: participantId,
                scenario: scenario,
                trial: trial,
                actions: actions, // ä¿æŒåŸå§‹åŠ¨ä½œåºåˆ—
                outcome: outcome,
                final_risk_level: finalLevel,
                final_pumps: finalLevel, // æ·»åŠ final_pumpså­—æ®µä¾›è´å¶æ–¯åˆ†æä½¿ç”¨
                locked_points: lockedPoints || 0,
                lost_points: lostPoints || 0,
                trial_duration: Date.now() - scenarioStartTime,
                risk_probabilities: actions.map(action => ({
                    level: action.new_level,
                    probability: calculateRiskProbability(action.new_level, scenario)
                })),
                timestamp: new Date().toISOString()
            };
            
            // ç¡®ä¿æ¯ä¸ªè¯•æ¬¡éƒ½è¢«è®°å½•åˆ°allExperimentDataä¸­
            allExperimentData.push(trialData);
            
            // ä¸ºè´å¶æ–¯åˆ†æå‡†å¤‡æ•°æ®
            if (!bayesianData[scenario]) {
                bayesianData[scenario] = [];
            }
            bayesianData[scenario].push(trialData);
            
            // è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®è¢«æ­£ç¡®è®°å½•
            console.log(`è®°å½•è¯•æ¬¡æ•°æ®: æƒ…å¢ƒ${scenario}, è¯•æ¬¡${trial}, ç»“æœ${outcome}, æ€»è®°å½•æ•°: ${allExperimentData.length}`);
        }
        
        // åˆ›å»ºåŒ»ç–—æƒ…å¢ƒç•Œé¢
        function createMedicalInterface(trial, intensity, healthPoints, healthPercent) {
            const intensityMarkers = Array.from({length: 10}, (_, i) => 
                `<div class="intensity-marker ${i < intensity ? 'active' : ''}"></div>`
            ).join('');
            
            return `
                <div class="experiment-container">
                    <div class="scenario-header scenario-medical">
                        <h2>ğŸ¥ åŒ»ç–—æƒ…å¢ƒï¼šæˆ‘çš„æ²»ç–—æ–¹æ¡ˆé€‰æ‹© (PTC)</h2>
                        <p>è¯•æ¬¡ ${trial}/${TRIALS_PER_SCENARIO}</p>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(trial-1)/TRIALS_PER_SCENARIO*100}%"></div>
                        </div>
                        <p>è¿›åº¦: ${trial-1}/${TRIALS_PER_SCENARIO} å®Œæˆ</p>
                    </div>
                    
                    <div class="health-status">
                        <h3>æˆ‘çš„å¥åº·çŠ¶æ€</h3>
                        <div class="health-bar-container">
                            <div class="health-bar" style="width: ${healthPercent}%"></div>
                        </div>
                        <p>å¥åº·æ„Ÿå—ç¨‹åº¦: ${healthPercent}%</p>
                    </div>
                    
                    <div style="text-align: center; margin: 25px 0;">
                        <h4>æ²»ç–—æ–¹æ¡ˆå¼ºåº¦ç­‰çº§</h4>
                        <div class="intensity-scale">
                            ${intensityMarkers}
                        </div>
                        <p>å½“å‰å¼ºåº¦: ${intensity}/10</p>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-value">${trial}</div>
                            <div class="stat-label">å½“å‰è¯•æ¬¡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${intensity}</div>
                            <div class="stat-label">æ²»ç–—å¼ºåº¦</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${healthPoints}</div>
                            <div class="stat-label">æœ¬æ¬¡å¥åº·ç‚¹æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${scenarioPoints[currentScenario]}</div>
                            <div class="stat-label">åŒ»ç–—æƒ…å¢ƒç´¯è®¡ç‚¹æ•°</div>
                        </div>
                    </div>
                    
                    <div class="button-container">
                        <button class="experiment-btn risk-btn" onclick="takeRisk()">
                            ğŸ’Š å¢åŠ æˆ‘çš„æ²»ç–—å¼ºåº¦
                        </button>
                        <button class="experiment-btn safe-btn" onclick="cashOut()">
                            âœ… ä¿æŒæ­¤å¼ºåº¦ï¼Œé”å®šå¥åº·ç‚¹æ•°
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px; color: #666;">
                        <p><small>å¼ºåº¦è¶Šé«˜ï¼Œå¥åº·æ”¹å–„è¶Šæ˜¾è‘—ï¼Œä½†å‰¯ä½œç”¨é£é™©ä¹Ÿè¶Šå¤§<br>
                        å½“å‰å‰¯ä½œç”¨é£é™©: ${(calculateRiskProbability(intensity + 1, 'PTC') * 100).toFixed(1)}%</small></p>
                    </div>
                </div>
            `;
        }
        
        // åˆ›å»ºç¤¾ä¼šæƒ…å¢ƒç•Œé¢
        function createSocialInterface(trial, requisitions, militaryPoints) {
            const regionName = regionNames[trial - 1] || `åœ°åŒº${trial}`;
            const unrestLevel = Math.min(requisitions * 15, 90); // æ°‘ä¼—ä¸æ»¡ç¨‹åº¦
            
            return `
                <div class="experiment-container">
                    <div class="scenario-header scenario-social">
                        <h2>âš”ï¸ ç¤¾ä¼šæƒ…å¢ƒï¼šæˆ˜æ—¶èµ„æºå¾æ”¶å†³ç­– (WRRD)</h2>
                        <p>è¾–åŒº ${trial}/${TRIALS_PER_SCENARIO} - ${regionName}</p>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(trial-1)/TRIALS_PER_SCENARIO*100}%"></div>
                        </div>
                        <p>è¿›åº¦: ${trial-1}/${TRIALS_PER_SCENARIO} å®Œæˆ</p>
                    </div>
                    
                    <div class="region-map ${requisitions > 3 ? 'unrest' : ''}">
                        <div class="region-info">
                            <h3>${regionName}</h3>
                            <p>æ°‘ä¼—ä¸æ»¡ç¨‹åº¦: ${unrestLevel}%</p>
                            <div style="margin: 10px 0;">
                                <div style="width: 100px; height: 10px; background: #e9ecef; border-radius: 5px; margin: 0 auto; overflow: hidden;">
                                    <div style="width: ${unrestLevel}%; height: 100%; background: ${unrestLevel > 60 ? '#dc3545' : unrestLevel > 30 ? '#ffc107' : '#28a745'}; transition: all 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="resource-bars">
                        <div class="resource-bar ${requisitions > 1 ? 'depleted' : ''}">
                            <div class="stat-value">${Math.max(100 - requisitions * 25, 0)}%</div>
                            <div class="stat-label">ç²®é£Ÿå‚¨å¤‡</div>
                        </div>
                        <div class="resource-bar ${requisitions > 2 ? 'depleted' : ''}">
                            <div class="stat-value">${Math.max(100 - requisitions * 20, 0)}%</div>
                            <div class="stat-label">äº¤é€šå·¥å…·</div>
                        </div>
                        <div class="resource-bar ${requisitions > 3 ? 'depleted' : ''}">
                            <div class="stat-value">${Math.max(100 - requisitions * 15, 0)}%</div>
                            <div class="stat-label">åŠ³åŠ¨åŠ›</div>
                        </div>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-value">${trial}</div>
                            <div class="stat-label">å½“å‰è¾–åŒº</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${requisitions}</div>
                            <div class="stat-label">å¾æ”¶æ¬¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${militaryPoints}</div>
                            <div class="stat-label">æœ¬æ¬¡å†›äº‹ç‚¹æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${scenarioPoints[currentScenario]}</div>
                            <div class="stat-label">ç¤¾ä¼šæƒ…å¢ƒç´¯è®¡ç‚¹æ•°</div>
                        </div>
                    </div>
                    
                    <div class="button-container">
                        <button class="experiment-btn risk-btn" onclick="takeRisk()">
                            âš”ï¸ è¿½åŠ ä¸€é¡¹å¾æ”¶æŒ‡ä»¤
                        </button>
                        <button class="experiment-btn safe-btn" onclick="cashOut()">
                            âœ… æŠ•å…¥æˆ˜åœºï¼Œé”å®šèµ„æº
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px; color: #666;">
                        <p><small>å¾æ”¶è¶Šå¤šï¼Œå†›äº‹å‚¨å¤‡è¶Šä¸°å¯Œï¼Œä½†æ°‘ä¼—æš´åŠ¨é£é™©ä¹Ÿè¶Šé«˜<br>
                        å½“å‰æš´åŠ¨é£é™©: ${(calculateRiskProbability(requisitions + 1, 'WRRD') * 100).toFixed(1)}%</small></p>
                    </div>
                </div>
            `;
        }
        
        // åˆ›å»ºç»æµæƒ…å¢ƒç•Œé¢
        function createEconomicInterface(trial, purchases, profitPoints) {
            const assetName = assetNames[(trial - 1) % assetNames.length];
            
            // åŠ¨æ€ä»·æ ¼è®¡ç®— - éšä¹°å…¥æ¬¡æ•°å¢åŠ ï¼Œä»·æ ¼ä¸Šæ¶¨ä½†æ³¢åŠ¨å¢å¤§
            let basePrice = 100;
            let priceChange = 0;
            let trendDescription = '';
            let trendColor = '';
            let riskWarning = '';
            
            if (purchases === 0) {
                priceChange = 0;
                trendDescription = 'å¹³ç¨³èµ·æ­¥';
                trendColor = '#28a745';
            } else if (purchases <= 2) {
                priceChange = purchases * 6 + Math.random() * 4 - 2;
                trendDescription = 'æ¸©å’Œä¸Šæ¶¨';
                trendColor = '#28a745';
            } else if (purchases <= 4) {
                priceChange = purchases * 8 + Math.random() * 8 - 4;
                trendDescription = 'åŠ é€Ÿä¸Šæ¶¨';
                trendColor = '#ffc107';
                riskWarning = 'âš ï¸ æ³¢åŠ¨åŠ å‰§';
            } else {
                priceChange = purchases * 10 + Math.random() * 12 - 6;
                trendDescription = 'æ€¥å‰§ä¸Šæ¶¨';
                trendColor = '#dc3545';
                riskWarning = 'âš ï¸ é«˜é£é™©åŒºåŸŸ';
            }
            
            const currentPrice = basePrice + priceChange;
            
            // åŠ¨æ€ç”ŸæˆSVGè¶‹åŠ¿çº¿
            function generateTrendPath(purchases) {
                let path = 'M10,150'; // èµ·å§‹ç‚¹
                
                if (purchases === 0) {
                    // å¹³ç¼“çº¿
                    path += ' L400,140';
                } else if (purchases <= 2) {
                    // æ¸©å’Œä¸Šå‡
                    path += ' Q100,145 200,130 T400,110';
                } else if (purchases <= 4) {
                    // åŠ é€Ÿä¸Šå‡ï¼Œæœ‰æ³¢åŠ¨
                    path += ' Q80,140 150,120 Q220,100 280,80 Q320,70 400,60';
                } else {
                    // æ€¥å‰§ä¸Šå‡ï¼Œå¤§æ³¢åŠ¨
                    path += ' Q60,130 120,90 Q180,50 240,40 Q300,30 360,20 L400,15';
                }
                
                return path;
            }
            
            const trendPath = generateTrendPath(purchases);
            const strokeColor = purchases <= 2 ? '#28a745' : purchases <= 4 ? '#ffc107' : '#dc3545';
            const strokeWidth = Math.min(2 + purchases * 0.5, 5);
            
            return `
                <div class="experiment-container">
                    <div class="scenario-header scenario-economic">
                        <h2>ğŸ’° ç»æµæƒ…å¢ƒï¼šæˆ‘çš„é€ç¬”æŠ•èµ„å†³ç­– (MID)</h2>
                        <p>æŠ•èµ„æ ‡çš„ ${trial}/${TRIALS_PER_SCENARIO}</p>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(trial-1)/TRIALS_PER_SCENARIO*100}%"></div>
                        </div>
                        <p>è¿›åº¦: ${trial-1}/${TRIALS_PER_SCENARIO} å®Œæˆ</p>
                    </div>
                    
                    <div class="asset-info">
                        <h3>${assetName}</h3>
                        <p>å½“å‰ä»·æ ¼: ï¿¥${currentPrice.toFixed(2)} ${priceChange > 0 ? 'ğŸ“ˆ' : priceChange < 0 ? 'ğŸ“‰' : 'â¡ï¸'}</p>
                        <p style="color: ${trendColor};">ğŸ“Š è¶‹åŠ¿: ${trendDescription} ${riskWarning}</p>
                        ${purchases > 0 ? `<p style="color: #666; font-size: 14px;">ä»·æ ¼å˜åŠ¨: ${priceChange > 0 ? '+' : ''}${priceChange.toFixed(2)}å…ƒ</p>` : ''}
                    </div>
                    
                    <div class="price-chart">
                        <svg width="100%" height="100%" viewBox="0 0 400 180" style="position: absolute; top: 0; left: 0;">
                            <!-- ç½‘æ ¼çº¿ -->
                            <defs>
                                <pattern id="grid" width="40" height="18" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 18" fill="none" stroke="#e9ecef" stroke-width="1"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)" />
                            
                            <!-- è¶‹åŠ¿çº¿ -->
                            <path d="${trendPath}" stroke="${strokeColor}" stroke-width="${strokeWidth}" fill="none" 
                                  style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); animation: ${purchases > 0 ? 'drawPath 1s ease-out' : 'none'};" />
                            
                            <!-- ä¹°å…¥ç‚¹æ ‡è®° -->
                            ${Array.from({length: purchases}, (_, i) => {
                                const x = 10 + (i + 1) * (390 / Math.max(purchases, 5));
                                const y = 150 - (i + 1) * (120 / Math.max(purchases, 5)) + Math.random() * 20 - 10;
                                return `<circle cx="${x}" cy="${y}" r="4" fill="${strokeColor}" stroke="white" stroke-width="2">
                                    <animate attributeName="r" values="2;6;4" dur="0.8s" begin="${i * 0.2}s"/>
                                </circle>`;
                            }).join('')}
                        </svg>
                        
                        <div style="position: absolute; bottom: 5px; right: 10px; font-size: 12px; color: #666;">
                            ${purchases}æ¬¡ä¹°å…¥ ${purchases > 0 ? `| æŒä»“æˆæœ¬: ï¿¥${(100 + purchases * 5).toFixed(2)}` : ''}
                        </div>
                        <div style="position: absolute; top: 5px; left: 10px; font-size: 12px; color: ${trendColor}; font-weight: bold;">
                            ${purchases > 2 ? `é£é™©ç­‰çº§: ${purchases <= 4 ? 'ä¸­' : 'é«˜'}` : ''}
                        </div>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-item">
                            <div class="stat-value">${trial}</div>
                            <div class="stat-label">æŠ•èµ„é¡¹ç›®</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${purchases}</div>
                            <div class="stat-label">ä¹°å…¥æ¬¡æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${profitPoints}</div>
                            <div class="stat-label">æœ¬æ¬¡æ½œåœ¨åˆ©æ¶¦</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${scenarioPoints[currentScenario]}</div>
                            <div class="stat-label">ç»æµæƒ…å¢ƒç´¯è®¡ç‚¹æ•°</div>
                        </div>
                    </div>
                    
                    <div class="button-container">
                        <button class="experiment-btn risk-btn" onclick="takeRisk()">
                            ğŸ’³ å†ç”¨æˆ‘çš„ç°é‡‘ä¹°ä¸€ç¬”
                        </button>
                        <button class="experiment-btn safe-btn" onclick="cashOut()">
                            âœ… åœæ­¢è´­ä¹°ï¼Œé”å®šåˆ©æ¶¦ç‚¹æ•°
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px; color: #666;">
                        <p><small>ä¹°å…¥è¶Šå¤šï¼Œæ½œåœ¨æ”¶ç›Šè¶Šé«˜ï¼Œä½†å´©ç›˜é£é™©ä¹Ÿè¶Šå¤§<br>
                        å½“å‰å´©ç›˜é£é™©: ${(calculateRiskProbability(purchases + 1, 'MID') * 100).toFixed(1)}%</small></p>
                        ${purchases > 3 ? `<p style="color: #dc3545; font-weight: bold; font-size: 14px; margin-top: 10px;">
                            âš ï¸ è­¦å‘Šï¼šä»·æ ¼æ³¢åŠ¨å‰§çƒˆï¼Œå´©ç›˜é£é™©æ˜¾è‘—ä¸Šå‡ï¼</p>` : ''}
                    </div>
                </div>
            `;
        }
        
        // å½“å‰è¯•æ¬¡çš„æ“ä½œè®°å½•
        let currentTrialActions = [];
        
        // é£é™©æ“ä½œ
        function takeRisk() {
            currentRiskLevel++;
            scenarioStartTime = scenarioStartTime || Date.now();
            
            const actionData = {
                timestamp: new Date().toISOString(),
                action_type: 'risk',
                new_level: currentRiskLevel,
                risk_probability: calculateRiskProbability(currentRiskLevel, currentScenario)
            };
            
            // æ ¹æ®æƒ…å¢ƒå¢åŠ ç‚¹æ•°
            let pointIncrement;
            switch(currentScenario) {
                case 'PTC': pointIncrement = 10; break;
                case 'WRRD': pointIncrement = 15; break;
                case 'MID': pointIncrement = 12; break;
            }
            
            currentPoints += pointIncrement;
            actionData.new_points = currentPoints;
            currentTrialActions.push(actionData);
            
            // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿè´Ÿé¢äº‹ä»¶
            if (checkNegativeOutcome(currentRiskLevel, currentScenario)) {
                // å‘ç”Ÿè´Ÿé¢äº‹ä»¶
                showNegativeOutcome();
            } else {
                // ç»§ç»­æ¸¸æˆï¼Œæ›´æ–°ç•Œé¢
                updateInterface();
            }
        }
        
        // å…‘ç°æ“ä½œ
        function cashOut() {
            const actionData = {
                timestamp: new Date().toISOString(),
                action_type: 'cash_out',
                final_level: currentRiskLevel,
                locked_points: currentPoints
            };
            currentTrialActions.push(actionData);
            
            // ä¿®æ”¹ï¼šæ›´æ–°å¯¹åº”æƒ…å¢ƒçš„ç´¯è®¡ç‚¹æ•°ï¼Œè€Œä¸æ˜¯å…¨å±€ç´¯è®¡
            scenarioPoints[currentScenario] += currentPoints;
            
            // è®°å½•æ•°æ®
            recordTrialData(
                currentScenario, 
                currentTrial, 
                currentTrialActions, 
                'cash_out', 
                currentRiskLevel, 
                currentPoints, 
                0
            );
            
            showPositiveOutcome();
        }
        
        // æ˜¾ç¤ºè´Ÿé¢ç»“æœ
        function showNegativeOutcome() {
            const lostPoints = currentPoints;
            
            // ä¿®æ”¹ï¼šç¡®ä¿è´Ÿé¢ç»“æœä¹Ÿè¢«è®°å½•
            recordTrialData(
                currentScenario, 
                currentTrial, 
                currentTrialActions, 
                'explosion', 
                currentRiskLevel, 
                0, 
                lostPoints
            );
            
            let message = '';
            switch(currentScenario) {
                case 'PTC':
                    message = `
                        <div class="feedback-message negative-feedback">
                            <h3>âš ï¸ å‡ºç°ä¸¥é‡å‰¯ä½œç”¨ï¼</h3>
                            <p style="font-size: 20px; margin: 20px 0;">
                                æ‚¨åœ¨å¼ºåº¦ç­‰çº§ ${currentRiskLevel} æ—¶å‡ºç°äº†ä¸¥é‡çš„è¯ç‰©å‰¯ä½œç”¨ååº”<br>
                                ï¼ˆå¦‚ä¸¥é‡æ¶å¿ƒã€çš®ç–¹æˆ–å…¶ä»–ä¸é€‚ç—‡çŠ¶ï¼‰
                            </p>
                            <p style="color: #dc3545; font-weight: bold; font-size: 18px;">
                                æ²»ç–—è¢«è¿«ä¸­æ–­ï¼Œæœ¬è¯•æ¬¡çš„ ${lostPoints} ç‚¹å¥åº·æ”¹å–„ç‚¹æ•°æ¸…é›¶
                            </p>
                        </div>
                    `;
                    break;
                case 'WRRD':
                    message = `
                        <div class="feedback-message negative-feedback">
                            <h3>âš ï¸ è¿‡åº¦å¾æ”¶å¼•å‘æš´åŠ¨ï¼</h3>
                            <p style="font-size: 20px; margin: 20px 0;">
                                åœ¨ç¬¬ ${currentRiskLevel} æ¬¡å¾æ”¶åï¼Œæ°‘ä¼—æ„¤æ€’è¾¾åˆ°ä¸´ç•Œç‚¹<br>
                                æš´æ°‘ç„šçƒ§ç²®ä»“ï¼Œç ´åè¿è¾“å·¥å…·ï¼Œç§©åºå½»åº•å´©æºƒ
                            </p>
                            <p style="color: #dc3545; font-weight: bold; font-size: 18px;">
                                å¾æ”¶è®¡åˆ’å¤±è´¥ï¼Œæœ¬è½®çš„ ${lostPoints} ç‚¹å†›äº‹å‚¨å¤‡ç‚¹æ•°æ¸…é›¶
                            </p>
                        </div>
                    `;
                    break;
                case 'MID':
                    message = `
                        <div class="feedback-message negative-feedback">
                            <h3>âš ï¸ æŠ•èµ„æ ‡çš„çªç„¶å´©ç›˜ï¼</h3>
                            <p style="font-size: 20px; margin: 20px 0;">
                                åœ¨ç¬¬ ${currentRiskLevel} æ¬¡ä¹°å…¥åï¼Œå¸‚åœºå‡ºç°å‰§çƒˆéœ‡è¡<br>
                                èµ„äº§ä»·æ ¼æš´è·Œè¶…è¿‡50%ï¼Œæ‚¨çš„æŒä»“å‡ºç°é‡å¤§æµ®äº
                            </p>
                            <p style="color: #dc3545; font-weight: bold; font-size: 18px;">
                                æŠ•èµ„å¤±è´¥ï¼Œæœ¬æ¬¡çš„ ${lostPoints} ç‚¹é¢„ä¼°åˆ©æ¶¦æ¸…é›¶
                            </p>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    ${message}
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="experiment-btn safe-btn" onclick="nextTrial()">
                            ç»§ç»­ä¸‹ä¸€ä¸ª${currentScenario === 'PTC' ? 'è¯•æ¬¡' : currentScenario === 'WRRD' ? 'è¾–åŒº' : 'æŠ•èµ„é¡¹ç›®'}
                        </button>
                    </div>
                </div>
            `;
            
            resetTrialData();
        }
        
        // æ˜¾ç¤ºæ­£é¢ç»“æœ
        function showPositiveOutcome() {
            let message = '';
            switch(currentScenario) {
                case 'PTC':
                    message = `
                        <div class="feedback-message positive-feedback">
                            <h3>âœ… æˆåŠŸé”å®šå¥åº·æ”¹å–„ï¼</h3>
                            <p style="font-size: 20px; margin: 20px 0;">
                                æ‚¨é€‰æ‹©åœ¨å¼ºåº¦ç­‰çº§ ${currentRiskLevel} æ—¶ä¿æŒæ²»ç–—æ–¹æ¡ˆ<br>
                                æˆåŠŸé”å®šäº† ${currentPoints} ç‚¹å¥åº·æ”¹å–„ç‚¹æ•°
                            </p>
                            <p style="color: #28a745; font-weight: bold; font-size: 18px;">
                                åŒ»ç–—æƒ…å¢ƒç´¯è®¡ç‚¹æ•°: ${scenarioPoints[currentScenario]} ç‚¹
                            </p>
                        </div>
                    `;
                    break;
                case 'WRRD':
                    message = `
                        <div class="feedback-message positive-feedback">
                            <h3>âœ… èµ„æºæˆåŠŸæŠ•å…¥æˆ˜åœºï¼</h3>
                            <p style="font-size: 20px; margin: 20px 0;">
                                æ‚¨åœ¨å¾æ”¶ ${currentRiskLevel} æ¬¡åæ˜æ™ºåœ°åœæ­¢å¾æ”¶<br>
                                æˆåŠŸé”å®šäº† ${currentPoints} ç‚¹å†›äº‹å‚¨å¤‡ç‚¹æ•°
                            </p>
                            <p style="color: #28a745; font-weight: bold; font-size: 18px;">
                                ç¤¾ä¼šæƒ…å¢ƒç´¯è®¡ç‚¹æ•°: ${scenarioPoints[currentScenario]} ç‚¹
                            </p>
                        </div>
                    `;
                    break;
                case 'MID':
                    message = `
                        <div class="feedback-message positive-feedback">
                            <h3>âœ… æˆåŠŸé”å®šæŠ•èµ„æ”¶ç›Šï¼</h3>
                            <p style="font-size: 20px; margin: 20px 0;">
                                æ‚¨åœ¨ä¹°å…¥ ${currentRiskLevel} æ¬¡åæ˜æ™ºåœ°åœæ­¢åŠ ä»“<br>
                                æˆåŠŸé”å®šäº† ${currentPoints} ç‚¹é¢„ä¼°åˆ©æ¶¦ç‚¹æ•°
                            </p>
                            <p style="color: #28a745; font-weight: bold; font-size: 18px;">
                                ç»æµæƒ…å¢ƒç´¯è®¡ç‚¹æ•°: ${scenarioPoints[currentScenario]} ç‚¹
                            </p>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    ${message}
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="experiment-btn safe-btn" onclick="nextTrial()">
                            è¿›å…¥ä¸‹ä¸€ä¸ª${currentScenario === 'PTC' ? 'è¯•æ¬¡' : currentScenario === 'WRRD' ? 'è¾–åŒº' : 'æŠ•èµ„é¡¹ç›®'}
                        </button>
                    </div>
                </div>
            `;
            
            resetTrialData();
        }
        
        // é‡ç½®è¯•æ¬¡æ•°æ®
        function resetTrialData() {
            currentRiskLevel = 0;
            currentPoints = 0;
            currentTrialActions = [];
        }
        
        // æ›´æ–°ç•Œé¢
        function updateInterface() {
            switch(currentScenario) {
                case 'PTC':
                    const healthPercent = Math.min(50 + currentRiskLevel * 5, 100);
                    document.getElementById('jspsych-target').innerHTML = createMedicalInterface(
                        currentTrial, currentRiskLevel, currentPoints, healthPercent
                    );
                    break;
                case 'WRRD':
                    document.getElementById('jspsych-target').innerHTML = createSocialInterface(
                        currentTrial, currentRiskLevel, currentPoints
                    );
                    break;
                case 'MID':
                    document.getElementById('jspsych-target').innerHTML = createEconomicInterface(
                        currentTrial, currentRiskLevel, currentPoints
                    );
                    break;
            }
        }
        
        // ä¸‹ä¸€è¯•æ¬¡
        function nextTrial() {
            currentTrial++;
            
            // ä¿®æ”¹ï¼šç¡®ä¿æ¯ä¸ªæƒ…å¢ƒéƒ½å®Œæˆå®Œæ•´çš„50ä¸ªè¯•æ¬¡
            if (currentTrial > TRIALS_PER_SCENARIO) {
                // å½“å‰æƒ…å¢ƒå®Œæˆï¼Œè¿›è¡Œè´å¶æ–¯å‚æ•°ä¼°è®¡ï¼Œç„¶åè¿›å…¥ä¸‹ä¸€æƒ…å¢ƒ
                console.log(`æƒ…å¢ƒ ${currentScenario} å®Œæˆï¼Œè®°å½•çš„è¯•æ¬¡æ•°: ${bayesianData[currentScenario] ? bayesianData[currentScenario].length : 0}`);
                performBayesianAnalysis(currentScenario);
                nextScenario();
            } else {
                setTimeout(() => {
                    updateInterface();
                }, 1000);
            }
        }
        
        // æ‰§è¡Œè´å¶æ–¯å‚æ•°åˆ†æ
        function performBayesianAnalysis(scenario) {
            console.log(`å¼€å§‹å¯¹${scenario}æƒ…å¢ƒè¿›è¡Œè´å¶æ–¯å‚æ•°åˆ†æ...`);
            
            // æ˜¾ç¤ºåˆ†æè¿›åº¦ç•Œé¢
            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    <div class="bayesian-results">
                        <h2 style="text-align: center; color: #9c27b0;">ğŸ§  æ­£åœ¨è¿›è¡Œè´å¶æ–¯å‚æ•°åˆ†æ</h2>
                        <div style="text-align: center; margin: 30px 0;">
                            <div class="loading-spinner"></div>
                            <p>æ­£åœ¨åˆ†ææ‚¨åœ¨${scenario === 'PTC' ? 'åŒ»ç–—' : scenario === 'WRRD' ? 'ç¤¾ä¼š' : 'ç»æµ'}æƒ…å¢ƒä¸­çš„å†³ç­–æ¨¡å¼...</p>
                            <p style="font-size: 14px; color: #666;">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´</p>
                        </div>
                    </div>
                </div>
            `;
            
            // å¼‚æ­¥æ‰§è¡Œå‚æ•°ä¼°è®¡
            setTimeout(() => {
                try {
                    const scenarioData = bayesianData[scenario] || [];
                    console.log(`${scenario}æƒ…å¢ƒæ•°æ®é‡: ${scenarioData.length} ä¸ªè¯•æ¬¡`);
                    const results = bayesianModel.estimateParameters(scenarioData, scenario);
                    const interpretation = bayesianModel.interpretParameters(results.parameters, scenario);
                    
                    // å­˜å‚¨ç»“æœ
                    bayesianData[scenario + '_results'] = {
                        parameters: results.parameters,
                        interpretation: interpretation,
                        logLikelihood: results.logLikelihood,
                        converged: results.converged
                    };
                    
                    console.log(`${scenario}æƒ…å¢ƒè´å¶æ–¯åˆ†æå®Œæˆ:`, results);
                    
                } catch (error) {
                    console.error(`${scenario}æƒ…å¢ƒè´å¶æ–¯åˆ†æå¤±è´¥:`, error);
                    // å³ä½¿åˆ†æå¤±è´¥ä¹Ÿç»§ç»­å®éªŒ
                }
            }, 100);
        }
        
        // è¿›å…¥ä¸‹ä¸€æƒ…å¢ƒ
        function nextScenario() {
            // å°†å½“å‰æƒ…å¢ƒç§»åˆ°å·²å®Œæˆåˆ—è¡¨
            completedScenarios.push(currentScenario);
            availableScenarios = availableScenarios.filter(s => s !== currentScenario);
            
            if (availableScenarios.length === 0) {
                // æ‰€æœ‰æƒ…å¢ƒå®Œæˆï¼Œè¿›è¡Œæœ€ç»ˆçš„è´å¶æ–¯åˆ†æå¹¶æ˜¾ç¤ºç»“æœ
                console.log(`æ‰€æœ‰æƒ…å¢ƒå®Œæˆï¼Œæ€»è®°å½•è¯•æ¬¡æ•°: ${allExperimentData.length}`);
                performFinalBayesianAnalysis();
            } else {
                // æ˜¾ç¤ºæƒ…å¢ƒå®Œæˆæç¤ºï¼Œç„¶åè®©ç”¨æˆ·é€‰æ‹©ä¸‹ä¸€ä¸ªæƒ…å¢ƒ
                showScenarioCompletionMessage();
            }
        }
        
        // æœ€ç»ˆè´å¶æ–¯åˆ†æ
        function performFinalBayesianAnalysis() {
            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    <div class="bayesian-results">
                        <h2 style="text-align: center; color: #9c27b0;">ğŸ§  æ­£åœ¨è¿›è¡Œæœ€ç»ˆçš„è·¨æƒ…å¢ƒè´å¶æ–¯åˆ†æ</h2>
                        <div style="text-align: center; margin: 30px 0;">
                            <div class="loading-spinner"></div>
                            <p>æ­£åœ¨æ•´åˆæ‚¨åœ¨æ‰€æœ‰æƒ…å¢ƒä¸­çš„å†³ç­–æ•°æ®...</p>
                            <p style="font-size: 14px; color: #666;">åˆ†ææ‚¨çš„ä¸ªæ€§åŒ–é£é™©å†³ç­–æ¨¡å¼</p>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                showFinalResults();
            }, 2000);
        }
        
        // æ˜¾ç¤ºæƒ…å¢ƒå®Œæˆæ¶ˆæ¯
        function showScenarioCompletionMessage() {
            const scenarioNames = {
                'PTC': 'åŒ»ç–—æƒ…å¢ƒ',
                'WRRD': 'ç¤¾ä¼šæƒ…å¢ƒ', 
                'MID': 'ç»æµæƒ…å¢ƒ'
            };
            
            const scenarioIcons = {
                'PTC': 'ğŸ¥',
                'WRRD': 'âš”ï¸',
                'MID': 'ğŸ’°'
            };
            
            const completedName = scenarioNames[currentScenario];
            const completedIcon = scenarioIcons[currentScenario];
            const remainingCount = availableScenarios.length;
            
            // æ˜¾ç¤ºå½“å‰æƒ…å¢ƒçš„è´å¶æ–¯åˆ†æç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
            const currentResults = bayesianData[currentScenario + '_results'];
            let bayesianSummary = '';
            
            if (currentResults && currentResults.parameters) {
                const { phi, eta, gamma, beta } = currentResults.parameters;
                const interp = currentResults.interpretation;
                
                bayesianSummary = `
                    <div class="bayesian-results" style="margin: 20px 0;">
                        <h3 style="color: #9c27b0;">ğŸ§  ${completedName}çš„è´å¶æ–¯å‚æ•°åˆ†æç»“æœ</h3>
                        <div class="parameter-grid">
                            <div class="parameter-card">
                                <h4>å…ˆéªŒä¿¡å¿µ (Î¦)</h4>
                                <div class="parameter-value">${phi.toFixed(3)}</div>
                                <div class="stat-label">${interp.phi.level}æ°´å¹³</div>
                                <div class="parameter-interpretation">${interp.phi.meaning}</div>
                            </div>
                            <div class="parameter-card">
                                <h4>å­¦ä¹ ç‡ (Î·)</h4>
                                <div class="parameter-value">${eta.toFixed(3)}</div>
                                <div class="stat-label">${interp.eta.level}å­¦ä¹ </div>
                                <div class="parameter-interpretation">${interp.eta.meaning}</div>
                            </div>
                            <div class="parameter-card">
                                <h4>é£é™©åå¥½ (Î³)</h4>
                                <div class="parameter-value">${gamma.toFixed(3)}</div>
                                <div class="stat-label">${interp.gamma.level}é£é™©åå¥½</div>
                                <div class="parameter-interpretation">${interp.gamma.meaning}</div>
                            </div>
                            <div class="parameter-card">
                                <h4>å†³ç­–ä¸€è‡´æ€§ (Î²)</h4>
                                <div class="parameter-value">${beta.toFixed(3)}</div>
                                <div class="stat-label">${interp.beta.level}ä¸€è‡´æ€§</div>
                                <div class="parameter-interpretation">${interp.beta.meaning}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    <div class="feedback-message positive-feedback">
                        <h2>${completedIcon} ${completedName}å®Œæˆï¼</h2>
                        <p style="font-size: 20px; margin: 20px 0;">
                            æ­å–œæ‚¨å®Œæˆäº†${completedName}çš„æ‰€æœ‰å†³ç­–ä»»åŠ¡ï¼<br>
                            æ‚¨çš„è¡¨ç°æ•°æ®å·²è¢«è®°å½•å¹¶åˆ†æã€‚
                        </p>
                        ${bayesianSummary}
                        <div style="background: rgba(255,255,255,0.3); padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <p style="font-size: 16px; margin: 10px 0;">
                                <strong>è¿›åº¦æ›´æ–°ï¼š</strong><br>
                                å·²å®Œæˆæƒ…å¢ƒï¼š${completedScenarios.length}/3<br>
                                å‰©ä½™æƒ…å¢ƒï¼š${remainingCount}ä¸ª<br>
                                <strong>${completedName}ç´¯è®¡ç‚¹æ•°ï¼š${scenarioPoints[currentScenario]} ç‚¹</strong>
                            </p>
                        </div>
                        <p style="font-size: 16px; color: #666;">
                            æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥ä»å‰©ä½™çš„${remainingCount}ä¸ªæƒ…å¢ƒä¸­<br>
                            é€‰æ‹©æ‚¨å¸Œæœ›è¿›è¡Œçš„ä¸‹ä¸€ä¸ªæƒ…å¢ƒ
                        </p>
                        <div style="margin: 30px 0;">
                            <button class="experiment-btn safe-btn" onclick="showScenarioSelection()">
                                é€‰æ‹©ä¸‹ä¸€ä¸ªæƒ…å¢ƒ â†’
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºæƒ…å¢ƒé€‰æ‹©ç•Œé¢
        function showScenarioSelection() {
            const scenarios = [
                {
                    id: 'PTC',
                    name: 'åŒ»ç–—æƒ…å¢ƒ',
                    icon: 'ğŸ¥',
                    title: 'æˆ‘çš„æ²»ç–—æ–¹æ¡ˆé€‰æ‹©',
                    description: 'æ¨¡æ‹Ÿæ‚¨ä¸ºè‡ªå·±é€‰æ‹©æ²»ç–—æ–¹æ¡ˆå¼ºåº¦çš„å†³ç­–è¿‡ç¨‹',
                    detail: 'æ”¶ç›Šï¼šå¥åº·æ”¹å–„ç‚¹æ•° | é£é™©ï¼šè¯ç‰©å‰¯ä½œç”¨',
                    color: '#2e7d32',
                    bgColor: 'linear-gradient(135deg, #e8f5e8, #c8e6c9)'
                },
                {
                    id: 'WRRD',
                    name: 'ç¤¾ä¼šæƒ…å¢ƒ',
                    icon: 'âš”ï¸',
                    title: 'æˆ˜æ—¶èµ„æºå¾æ”¶å†³ç­–',
                    description: 'æ¨¡æ‹Ÿæˆ˜æ—¶å®˜å‘˜è¿›è¡Œèµ„æºå¾æ”¶çš„å†³ç­–è¿‡ç¨‹',
                    detail: 'æ”¶ç›Šï¼šå†›äº‹å‚¨å¤‡ç‚¹æ•° | é£é™©ï¼šæ°‘ä¼—æš´åŠ¨',
                    color: '#ef6c00',
                    bgColor: 'linear-gradient(135deg, #fff3e0, #ffcc80)'
                },
                {
                    id: 'MID',
                    name: 'ç»æµæƒ…å¢ƒ',
                    icon: 'ğŸ’°',
                    title: 'æˆ‘çš„é€ç¬”æŠ•èµ„å†³ç­–',
                    description: 'æ¨¡æ‹Ÿæ‚¨è¿›è¡ŒæŠ•èµ„åŠ ä»“çš„å†³ç­–è¿‡ç¨‹',
                    detail: 'æ”¶ç›Šï¼šé¢„ä¼°åˆ©æ¶¦ç‚¹æ•° | é£é™©ï¼šèµ„äº§å´©ç›˜',
                    color: '#1565c0',
                    bgColor: 'linear-gradient(135deg, #e3f2fd, #90caf9)'
                }
            ];

            const availableScenarioCards = scenarios
                .filter(scenario => availableScenarios.includes(scenario.id))
                .map(scenario => `
                    <div class="scenario-card" style="background: ${scenario.bgColor}; border: 3px solid ${scenario.color};" 
                         onclick="selectScenario('${scenario.id}')">
                        <div class="scenario-icon" style="font-size: 60px; margin-bottom: 15px;">${scenario.icon}</div>
                        <h3 style="color: ${scenario.color}; margin: 10px 0;">${scenario.name}</h3>
                        <h4 style="color: ${scenario.color}; margin: 5px 0; font-size: 16px;">${scenario.title}</h4>
                        <p style="margin: 15px 0; font-size: 14px; line-height: 1.5;">${scenario.description}</p>
                        <p style="font-size: 12px; color: #666; margin: 10px 0;">${scenario.detail}</p>
                        <div class="select-btn" style="background: ${scenario.color}; color: white; padding: 10px 20px; border-radius: 25px; margin-top: 15px; font-weight: bold;">
                            é€‰æ‹©æ­¤æƒ…å¢ƒ
                        </div>
                    </div>
                `).join('');

            const completedCount = completedScenarios.length;
            const totalCount = 3;

            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="color: #1976d2;">æƒ…å¢ƒé€‰æ‹©</h1>
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 15px; margin: 20px 0;">
                            <h3>è¿›åº¦ï¼š${completedCount}/${totalCount} æƒ…å¢ƒå·²å®Œæˆ</h3>
                            <p style="font-size: 16px;">
                                ${completedCount === 0 ? 'è¯·é€‰æ‹©æ‚¨æƒ³è¦å¼€å§‹çš„ç¬¬ä¸€ä¸ªæƒ…å¢ƒ' : 
                                  completedCount === 1 ? 'è¯·é€‰æ‹©æ‚¨æƒ³è¦è¿›è¡Œçš„ç¬¬äºŒä¸ªæƒ…å¢ƒ' : 
                                  'è¯·é€‰æ‹©æœ€åä¸€ä¸ªæƒ…å¢ƒ'}
                            </p>
                            ${completedCount > 0 ? `<p style="font-size: 14px; color: #666;">
                                å·²å®Œæˆæƒ…å¢ƒï¼š${completedScenarios.map(id => scenarios.find(s => s.id === id).name).join('ã€')}
                            </p>` : ''}
                            ${completedCount > 0 ? `<p style="font-size: 14px; color: #666;">
                                ç´¯è®¡ç‚¹æ•°ï¼š${Object.entries(scenarioPoints).filter(([key, _]) => completedScenarios.includes(key)).map(([key, value]) => `${scenarios.find(s => s.id === key).name}: ${value}`).join('ï¼Œ')}
                            </p>` : ''}
                        </div>
                    </div>
                    
                    <div class="scenario-selection-grid">
                        ${availableScenarioCards}
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; font-size: 14px; color: #666;">
                        <p>æ‚¨å¯ä»¥æŒ‰ç…§è‡ªå·±çš„åå¥½é€‰æ‹©æƒ…å¢ƒé¡ºåº</p>
                        <p>æ¯ä¸ªæƒ…å¢ƒåŒ…å«${TRIALS_PER_SCENARIO}ä¸ªç‹¬ç«‹è¯•æ¬¡ï¼Œå®Œæˆåå°†è¿›è¡Œè´å¶æ–¯å‚æ•°åˆ†æ</p>
                    </div>
                </div>
            `;
        }
        
        // é€‰æ‹©æƒ…å¢ƒ
        function selectScenario(scenarioId) {
            startScenario(scenarioId);
        }
        
        // å¼€å§‹ç‰¹å®šæƒ…å¢ƒ
        function startScenario(scenario) {
            currentScenario = scenario;
            currentTrial = 1;
            resetTrialData();
            scenarioStartTime = Date.now();
            
            let instructions = '';
            switch(scenario) {
                case 'PTC':
                    instructions = `
                        <h2 style="color: #2e7d32;">ğŸ¥ åŒ»ç–—æƒ…å¢ƒï¼šæˆ‘çš„æ²»ç–—æ–¹æ¡ˆé€‰æ‹©</h2>
                        <p>åœ¨æ¥ä¸‹æ¥çš„ä»»åŠ¡ä¸­ï¼Œæ‚¨å°†é¢ä¸´ä¸€ç³»åˆ—æ‚¨è‡ªå·±çš„å¥åº·å†³ç­–æ¨¡æ‹Ÿã€‚è¯·æƒ³è±¡æ‚¨è¢«è¯Šæ–­æ‚£æœ‰ä¸€ç§æ…¢æ€§ä½†å¯æ§çš„ç–¾ç—…ï¼ˆå¦‚ä¸­åº¦å…³èŠ‚ç‚ã€ç‰¹å®šè¿‡æ•ç—‡ï¼‰ã€‚</p>
                        <p>æ¯è½®è¯•æ¬¡å‡åœ¨ä¸­ç­‰å¥åº·çŠ¶å†µä¸‹è¿›è¡Œï¼Œç‚¹å‡»å·¦ä¾§æŒ‰é’®éƒ½å¯ä»¥å¢åŠ æ²»ç–—å¼ºåº¦ï¼Œæ‚¨çš„"å¥åº·æ”¹å–„ç‚¹æ•°"ä¼šæé«˜ï¼Œä½†å‰¯ä½œç”¨é£é™©ä¹Ÿåœ¨å¢åŠ ã€‚</p>
                        <p>è‹¥ç»§ç»­å¢åŠ å¼ºåº¦ç›´è‡³è§¦å‘"ä¸¥é‡å‰¯ä½œç”¨"ï¼Œæ‚¨çš„å¥åº·ç‚¹æ•°æ¸…é›¶å¹¶è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€è¯•æ¬¡ã€‚ç‚¹å‡»å³ä¾§æŒ‰é’®åˆ™ä¿ç•™å½“å‰å¥åº·ç‚¹æ•°ç»§ç»­è¿›å…¥ä¸‹ä¸€è¯•æ¬¡ã€‚</p>
                        <p>å…±éœ€å®Œæˆ<strong>${TRIALS_PER_SCENARIO}ä¸ªç‹¬ç«‹è¯•æ¬¡</strong>ã€‚<strong>æ¯ä¸ªè¯•æ¬¡å‡ä¸ºå…¨æ–°å¼€å§‹ï¼Œäº’ä¸å½±å“</strong>ã€‚</p>
                        <p style="color: #9c27b0;"><strong>å®Œæˆåå°†è¿›è¡Œè´å¶æ–¯å››å‚æ•°åˆ†æï¼Œè¯„ä¼°æ‚¨çš„ä¸ªæ€§åŒ–å†³ç­–æ¨¡å¼ã€‚</strong></p>
                    `;
                    break;
                case 'WRRD':
                    instructions = `
                        <h2 style="color: #ef6c00;">âš”ï¸ ç¤¾ä¼šæƒ…å¢ƒï¼šæˆ˜æ—¶èµ„æºå¾æ”¶å†³ç­–</h2>
                        <p>æ‚¨ä½œä¸ºæˆ˜æ—¶å†³ç­–è€…ï¼Œéœ€é€šè¿‡å¾æ”¶èµ„æºç»´æŒå†›é˜Ÿæˆ˜æ–—åŠ›ã€‚</p>
                        <p>æ¯æ¬¡è¿½åŠ å¾æ”¶ï¼Œæ‚¨çš„"å†›äº‹å‚¨å¤‡ç‚¹æ•°"å¢åŠ ï¼Œä½†æ°‘ä¼—ä¸æ»¡é£é™©ä¸Šå‡ã€‚</p>
                        <p>è‹¥è§¦å‘"æ°‘ä¼—æš´åŠ¨"ï¼Œæœ¬è½®å¾æ”¶æ”¶ç›Šæ¸…é›¶ï¼Œè¿›å…¥ä¸‹ä¸€è¾–åŒºã€‚</p>
                        <p>æ‚¨å°†åœ¨${TRIALS_PER_SCENARIO}ä¸ªè¾–åŒºè¿›è¡Œèµ„æºå¾æ”¶å†³ç­–ã€‚</p>
                        <p style="color: #9c27b0;"><strong>å®Œæˆåå°†è¿›è¡Œè´å¶æ–¯å››å‚æ•°åˆ†æï¼Œè¯„ä¼°æ‚¨çš„ä¸ªæ€§åŒ–å†³ç­–æ¨¡å¼ã€‚</strong></p>
                    `;
                    break;
                case 'MID':
                    instructions = `
                        <h2 style="color: #1565c0;">ğŸ’° ç»æµæƒ…å¢ƒï¼šæˆ‘çš„é€ç¬”æŠ•èµ„å†³ç­–</h2>
                        <p>æ‚¨æ­£åœ¨ç®¡ç†è‡ªå·±çš„æŠ•èµ„è´¦æˆ·ï¼Œé¢å¯¹å…·æœ‰æ½œåŠ›ä½†æ³¢åŠ¨æ€§æœªçŸ¥çš„èµ„äº§ã€‚</p>
                        <p>æ¯æ¬¡è´­ä¹°ï¼Œæ‚¨çš„"é¢„ä¼°æ½œåœ¨åˆ©æ¶¦ç‚¹æ•°"ç´¯ç§¯ï¼Œä½†å´©ç›˜é£é™©ä¹Ÿåœ¨å¢åŠ ã€‚</p>
                        <p>è‹¥é­é‡çªç„¶å´©ç›˜ï¼Œæ‚¨çš„æ½œåœ¨åˆ©æ¶¦ç‚¹æ•°æ¸…é›¶ã€‚</p>
                        <p>æ‚¨å°†äº¤æ˜“${TRIALS_PER_SCENARIO}åªç‹¬ç«‹çš„æŠ•èµ„æ ‡çš„ã€‚</p>
                        <p style="color: #9c27b0;"><strong>å®Œæˆåå°†è¿›è¡Œè´å¶æ–¯å››å‚æ•°åˆ†æï¼Œè¯„ä¼°æ‚¨çš„ä¸ªæ€§åŒ–å†³ç­–æ¨¡å¼ã€‚</strong></p>
                    `;
                    break;
            }
            
            document.getElementById('jspsych-target').innerHTML = `
                <div class="experiment-container">
                    <div style="text-align: center; padding: 40px;">
                        ${instructions}
                        <div style="margin: 40px 0;">
                            <button class="experiment-btn safe-btn" onclick="updateInterface()">å¼€å§‹${scenario === 'PTC' ? 'åŒ»ç–—' : scenario === 'WRRD' ? 'ç¤¾ä¼š' : 'ç»æµ'}æƒ…å¢ƒ</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ä¿®æ”¹ï¼šæ˜¾ç¤ºæœ€ç»ˆç»“æœï¼Œæ­£ç¡®è®¡ç®—å„æƒ…å¢ƒç»Ÿè®¡
        function showFinalResults() {
            // è®¡ç®—å„æƒ…å¢ƒçš„ç»Ÿè®¡æ•°æ®
            const ptcData = allExperimentData.filter(d => d.scenario === 'PTC');
            const wrrdData = allExperimentData.filter(d => d.scenario === 'WRRD');
            const midData = allExperimentData.filter(d => d.scenario === 'MID');
            
            const stats = {};
            
            [['PTC', ptcData], ['WRRD', wrrdData], ['MID', midData]].forEach(([scenario, data]) => {
                const successTrials = data.filter(d => d.outcome === 'cash_out');
                const explosionTrials = data.filter(d => d.outcome === 'explosion');
                
                stats[scenario] = {
                    totalTrials: data.length,
                    avgFinalLevel: successTrials.length > 0 ? 
                        (successTrials.reduce((sum, d) => sum + d.final_risk_level, 0) / successTrials.length).toFixed(2) : 0,
                    avgLockedPoints: successTrials.length > 0 ?
                        (successTrials.reduce((sum, d) => sum + d.locked_points, 0) / successTrials.length).toFixed(1) : 0,
                    explosionRate: ((explosionTrials.length / data.length) * 100).toFixed(1),
                    avgExplosionLevel: explosionTrials.length > 0 ?
                        (explosionTrials.reduce((sum, d) => sum + d.final_risk_level, 0) / explosionTrials.length).toFixed(2) : 0,
                    totalLocked: scenarioPoints[scenario] // ä½¿ç”¨å„æƒ…å¢ƒçš„å®é™…ç´¯è®¡ç‚¹æ•°
                };
            });
            
            // è®¡ç®—æ€»ç´¯è®¡ç‚¹æ•°
            const totalPoints = scenarioPoints.PTC + scenarioPoints.WRRD + scenarioPoints.MID;
            
            // ç”Ÿæˆè´å¶æ–¯å‚æ•°æ¯”è¾ƒ
            let bayesianComparison = '';
            const hasAllResults = completedScenarios.every(scenario => bayesianData[scenario + '_results']);
            
            if (hasAllResults) {
                bayesianComparison = `
                    <div class="bayesian-results">
                        <h2 style="text-align: center; color: #9c27b0;">ğŸ§  è·¨æƒ…å¢ƒè´å¶æ–¯å‚æ•°åˆ†æ</h2>
                        <p style="text-align: center; margin-bottom: 30px;">åŸºäºæ‚¨åœ¨ä¸‰ä¸ªæƒ…å¢ƒä¸­çš„å®Œæ•´å†³ç­–æ•°æ®è¿›è¡Œçš„ä¸ªæ€§åŒ–è®¤çŸ¥å»ºæ¨¡</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                            ${completedScenarios.map(scenario => {
                                const results = bayesianData[scenario + '_results'];
                                const scenarioNames = {'PTC': 'åŒ»ç–—æƒ…å¢ƒ', 'WRRD': 'ç¤¾ä¼šæƒ…å¢ƒ', 'MID': 'ç»æµæƒ…å¢ƒ'};
                                const scenarioIcons = {'PTC': 'ğŸ¥', 'WRRD': 'âš”ï¸', 'MID': 'ğŸ’°'};
                                
                                if (results && results.parameters) {
                                    const { phi, eta, gamma, beta } = results.parameters;
                                    const interp = results.interpretation;
                                    
                                    return `
                                        <div style="background: rgba(255,255,255,0.9); padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                                            <h3 style="color: #1976d2; text-align: center;">${scenarioIcons[scenario]} ${scenarioNames[scenario]}</h3>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                                    <div style="font-size: 18px; font-weight: bold; color: #9c27b0;">${phi.toFixed(3)}</div>
                                                    <div style="font-size: 12px;">å…ˆéªŒä¿¡å¿µ (Î¦)</div>
                                                    <div style="font-size: 11px; color: #666;">${interp.phi.level}æ°´å¹³</div>
                                                </div>
                                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                                    <div style="font-size: 18px; font-weight: bold; color: #9c27b0;">${eta.toFixed(3)}</div>
                                                    <div style="font-size: 12px;">å­¦ä¹ ç‡ (Î·)</div>
                                                    <div style="font-size: 11px; color: #666;">${interp.eta.level}å­¦ä¹ </div>
                                                </div>
                                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                                    <div style="font-size: 18px; font-weight: bold; color: #9c27b0;">${gamma.toFixed(3)}</div>
                                                    <div style="font-size: 12px;">é£é™©åå¥½ (Î³)</div>
                                                    <div style="font-size: 11px; color: #666;">${interp.gamma.level}é£é™©åå¥½</div>
                                                </div>
                                                <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                                    <div style="font-size: 18px; font-weight: bold; color: #9c27b0;">${beta.toFixed(3)}</div>
                                                    <div style="font-size: 12px;">å†³ç­–ä¸€è‡´æ€§ (Î²)</div>
                                                    <div style="font-size: 11px; color: #666;">${interp.beta.level}ä¸€è‡´æ€§</div>
                                                </div>
                                            </div>
                                            <div style="background: #fff8e1; padding: 10px; border-radius: 8px; margin-top: 15px;">
                                                <div style="font-size: 13px; line-height: 1.4;">
                                                    <strong>æ ¸å¿ƒç‰¹å¾ï¼š</strong>${interp.gamma.meaning}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div style="background: rgba(255,255,255,0.9); padding: 25px; border-radius: 15px; border: 2px solid #e0e0e0;">
                                            <h3 style="color: #1976d2; text-align: center;">${scenarioIcons[scenario]} ${scenarioNames[scenario]}</h3>
                                            <p style="text-align: center; color: #666;">å‚æ•°åˆ†ææœªå®Œæˆ</p>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                        
                        <div style="background: rgba(156, 39, 176, 0.1); padding: 25px; border-radius: 15px; margin: 30px 0;">
                            <h3 style="color: #9c27b0; text-align: center;">ğŸ” è·¨æƒ…å¢ƒä¸ªæ€§åŒ–é£é™©å†³ç­–æ¨¡å¼è§£è¯»</h3>
                            ${generateCrossScenarioAnalysis()}
                        </div>
                    </div>
                `;
            } else {
                bayesianComparison = `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffc107;">
                        <h3 style="color: #856404;">âš ï¸ è´å¶æ–¯å‚æ•°åˆ†æ</h3>
                        <p>éƒ¨åˆ†æƒ…å¢ƒçš„å‚æ•°åˆ†ææœªå®Œæˆï¼Œä½†åŸºç¡€è¡Œä¸ºæ•°æ®å·²å®Œæ•´è®°å½•ã€‚</p>
                    </div>
                `;
            }
            
            document.getElementById('jspsych-target').innerHTML = `
                <div class="results-container">
                    <h1 style="text-align: center; color: #1976d2;">ğŸ‰ è·¨æƒ…å¢ƒé£é™©å†³ç­–æµ‹éªŒå®Œæˆï¼</h1>
                    <h2 style="text-align: center; margin-bottom: 40px;">æ‚¨çš„ä¸ªæ€§åŒ–é£é™©å†³ç­–åˆ†ææŠ¥å‘Š</h2>
                    
                    <div style="background: #f0f8ff; padding: 25px; border-radius: 15px; margin: 30px 0; border: 2px solid #1976d2;">
                        <h3 style="text-align: center; color: #1976d2;">ğŸ“Š æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${stats.PTC.totalTrials}</div>
                                <div style="font-size: 14px;">åŒ»ç–—æƒ…å¢ƒè¯•æ¬¡</div>
                                <div style="font-size: 12px; color: #666;">ç›®æ ‡: ${TRIALS_PER_SCENARIO}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${stats.WRRD.totalTrials}</div>
                                <div style="font-size: 14px;">ç¤¾ä¼šæƒ…å¢ƒè¯•æ¬¡</div>
                                <div style="font-size: 12px; color: #666;">ç›®æ ‡: ${TRIALS_PER_SCENARIO}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${stats.MID.totalTrials}</div>
                                <div style="font-size: 14px;">ç»æµæƒ…å¢ƒè¯•æ¬¡</div>
                                <div style="font-size: 12px; color: #666;">ç›®æ ‡: ${TRIALS_PER_SCENARIO}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${allExperimentData.length}</div>
                                <div style="font-size: 14px;">æ€»è®°å½•è¯•æ¬¡</div>
                                <div style="font-size: 12px; color: #666;">ç›®æ ‡: ${TRIALS_PER_SCENARIO * 3}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>ğŸ¥ åŒ»ç–—æƒ…å¢ƒ (PTC)</h4>
                            <div class="result-value">${stats.PTC.avgFinalLevel}</div>
                            <p>å¹³å‡ç»ˆæ­¢å¼ºåº¦</p>
                            <p><small>å‰¯ä½œç”¨ç‡: ${stats.PTC.explosionRate}%</small></p>
                            <p><small>ç´¯è®¡ç‚¹æ•°: ${stats.PTC.totalLocked}</small></p>
                        </div>
                        
                        <div class="result-card">
                            <h4>âš”ï¸ ç¤¾ä¼šæƒ…å¢ƒ (WRRD)</h4>
                            <div class="result-value">${stats.WRRD.avgFinalLevel}</div>
                            <p>å¹³å‡å¾æ”¶æ¬¡æ•°</p>
                            <p><small>æš´åŠ¨ç‡: ${stats.WRRD.explosionRate}%</small></p>
                            <p><small>ç´¯è®¡ç‚¹æ•°: ${stats.WRRD.totalLocked}</small></p>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ’° ç»æµæƒ…å¢ƒ (MID)</h4>
                            <div class="result-value">${stats.MID.avgFinalLevel}</div>
                            <p>å¹³å‡ä¹°å…¥æ¬¡æ•°</p>
                            <p><small>å´©ç›˜ç‡: ${stats.MID.explosionRate}%</small></p>
                            <p><small>ç´¯è®¡ç‚¹æ•°: ${stats.MID.totalLocked}</small></p>
                        </div>
                        
                        <div class="result-card">
                            <h4>æ€»ä½“æ•ˆç‡</h4>
                            <div class="result-value">${totalPoints}</div>
                            <p>ä¸‰æƒ…å¢ƒç´¯è®¡æ€»ç‚¹æ•°</p>
                            <p><small>è·¨æƒ…å¢ƒè¡¨ç°</small></p>
                        </div>
                    </div>
                    
                    ${bayesianComparison}
                    
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; margin: 40px 0;">
                        <h3 style="text-align: center; color: #1976d2;">ğŸ“Š æ‚¨çš„æƒ…å¢ƒé€‰æ‹©é¡ºåº</h3>
                        <p style="text-align: center; font-size: 16px; margin: 15px 0;">
                            ${completedScenarios.map((scenario, index) => {
                                const names = {'PTC': 'åŒ»ç–—æƒ…å¢ƒ', 'WRRD': 'ç¤¾ä¼šæƒ…å¢ƒ', 'MID': 'ç»æµæƒ…å¢ƒ'};
                                const icons = {'PTC': 'ğŸ¥', 'WRRD': 'âš”ï¸', 'MID': 'ğŸ’°'};
                                return `${index + 1}. ${icons[scenario]} ${names[scenario]}`;
                            }).join(' â†’ ')}
                        </p>
                        
                        <h3 style="text-align: center; color: #1976d2; margin-top: 30px;">ğŸ’° å„æƒ…å¢ƒç‚¹æ•°æ˜ç»†</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="text-align: center; padding: 15px; background: rgba(46, 125, 50, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">ğŸ¥ ${scenarioPoints.PTC}</div>
                                <div style="font-size: 14px;">åŒ»ç–—æƒ…å¢ƒç‚¹æ•°</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(239, 108, 0, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #ef6c00;">âš”ï¸ ${scenarioPoints.WRRD}</div>
                                <div style="font-size: 14px;">ç¤¾ä¼šæƒ…å¢ƒç‚¹æ•°</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(21, 101, 192, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1565c0;">ğŸ’° ${scenarioPoints.MID}</div>
                                <div style="font-size: 14px;">ç»æµæƒ…å¢ƒç‚¹æ•°</div>
                            </div>
                        </div>
                        
                        <h3 style="text-align: center; color: #1976d2; margin-top: 30px;">ğŸ’° å®éªŒæŠ¥é…¬è®¡ç®—</h3>
                        <p style="text-align: center; font-size: 18px;">
                            åŸºç¡€æŠ¥é…¬ + ${(totalPoints * 0.005).toFixed(2)}å…ƒ (é£é™©å†³ç­–å¥–åŠ±)
                        </p>
                        
                        <h3 style="text-align: center; color: #1976d2; margin-top: 30px;">ğŸ“ˆ å®éªŒæ•°æ®æ¦‚è§ˆ</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${TRIALS_PER_SCENARIO * 3}</div>
                                <div style="font-size: 14px;">é¢„æœŸæ€»è¯•æ¬¡</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${allExperimentData.length}</div>
                                <div style="font-size: 14px;">å®é™…è®°å½•è¯•æ¬¡</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${allExperimentData.filter(d => d.outcome === 'cash_out').length}</div>
                                <div style="font-size: 14px;">æˆåŠŸå…‘ç°</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(25, 118, 210, 0.1); border-radius: 10px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${allExperimentData.filter(d => d.outcome === 'explosion').length}</div>
                                <div style="font-size: 14px;">å‘ç”Ÿçˆ†ç‚¸</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="download-btn" onclick="downloadAllData()">
                            ğŸ“Š ä¸‹è½½å®Œæ•´å®éªŒæ•°æ®
                        </button>
                        <button class="download-btn" onclick="downloadBayesianResults()">
                            ğŸ§  ä¸‹è½½è´å¶æ–¯åˆ†ææŠ¥å‘Š
                        </button>
                        <button class="download-btn" onclick="downloadSummaryReport()">
                            ğŸ“‹ ä¸‹è½½ç»¼åˆåˆ†ææŠ¥å‘Š
                        </button>
                        <button class="restart-btn" onclick="location.reload()">
                            ğŸ”„ é‡æ–°å¼€å§‹æµ‹éªŒ
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ç”Ÿæˆè·¨æƒ…å¢ƒåˆ†æ
        function generateCrossScenarioAnalysis() {
            let analysis = '<div style="line-height: 1.6;">';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„è´å¶æ–¯ç»“æœ
            const hasAllResults = completedScenarios.every(scenario => bayesianData[scenario + '_results']);
            
            if (hasAllResults) {
                // æå–å„æƒ…å¢ƒçš„å‚æ•°
                const ptcResults = bayesianData['PTC_results'];
                const wrrdResults = bayesianData['WRRD_results'];
                const midResults = bayesianData['MID_results'];
                
                if (ptcResults && wrrdResults && midResults) {
                    const scenarios = [
                        { name: 'åŒ»ç–—æƒ…å¢ƒ', key: 'PTC', results: ptcResults },
                        { name: 'ç¤¾ä¼šæƒ…å¢ƒ', key: 'WRRD', results: wrrdResults },
                        { name: 'ç»æµæƒ…å¢ƒ', key: 'MID', results: midResults }
                    ];
                    
                    // æ‰¾å‡ºå„å‚æ•°æœ€é«˜çš„æƒ…å¢ƒ
                    const maxPhi = scenarios.reduce((max, s) => s.results.parameters.phi > max.results.parameters.phi ? s : max);
                    const maxGamma = scenarios.reduce((max, s) => s.results.parameters.gamma > max.results.parameters.gamma ? s : max);
                    const maxEta = scenarios.reduce((max, s) => s.results.parameters.eta > max.results.parameters.eta ? s : max);
                    const maxBeta = scenarios.reduce((max, s) => s.results.parameters.beta > max.results.parameters.beta ? s : max);
                    
                    analysis += `
                        <p><strong>ğŸ¯ å…ˆéªŒä¿¡å¿µå·®å¼‚ï¼š</strong>æ‚¨åœ¨<span style="color: #9c27b0; font-weight: bold;">${maxPhi.name}</span>ä¸­è¡¨ç°å‡ºæœ€ä¹è§‚çš„å…ˆéªŒä¿¡å¿µï¼ˆÎ¦=${maxPhi.results.parameters.phi.toFixed(3)}ï¼‰ï¼Œè¿™è¡¨æ˜æ‚¨åœ¨è¯¥æƒ…å¢ƒä¸‹æ›´å€¾å‘äºè®¤ä¸ºé£é™©ä¸ä¼šå‘ç”Ÿã€‚</p>
                        
                        <p><strong>ğŸ² é£é™©åå¥½å·®å¼‚ï¼š</strong>æ‚¨åœ¨<span style="color: #9c27b0; font-weight: bold;">${maxGamma.name}</span>ä¸­è¡¨ç°å‡ºæœ€å¼ºçš„é£é™©åå¥½ï¼ˆÎ³=${maxGamma.results.parameters.gamma.toFixed(3)}ï¼‰ï¼Œè¯´æ˜æ‚¨åœ¨è¯¥æƒ…å¢ƒä¸‹æ›´æ„¿æ„æ‰¿æ‹…é£é™©ä»¥è·å¾—æ›´é«˜æ”¶ç›Šã€‚</p>
                        
                        <p><strong>ğŸ“š å­¦ä¹ é€Ÿåº¦å·®å¼‚ï¼š</strong>æ‚¨åœ¨<span style="color: #9c27b0; font-weight: bold;">${maxEta.name}</span>ä¸­å­¦ä¹ é€Ÿåº¦æœ€å¿«ï¼ˆÎ·=${maxEta.results.parameters.eta.toFixed(3)}ï¼‰ï¼Œèƒ½å¤Ÿæ›´å¿«åœ°æ ¹æ®åé¦ˆè°ƒæ•´ç­–ç•¥ã€‚</p>
                        
                        <p><strong>ğŸ¯ å†³ç­–ä¸€è‡´æ€§å·®å¼‚ï¼š</strong>æ‚¨åœ¨<span style="color: #9c27b0; font-weight: bold;">${maxBeta.name}</span>ä¸­å†³ç­–æœ€ä¸ºä¸€è‡´ï¼ˆÎ²=${maxBeta.results.parameters.beta.toFixed(3)}ï¼‰ï¼Œè¡¨æ˜åœ¨è¯¥æƒ…å¢ƒä¸‹æ‚¨çš„å†³ç­–æ›´åŠ ç†æ€§å’Œç¨³å®šã€‚</p>
                        
                        <p><strong>ğŸ” ç»¼åˆè¯„ä¼°ï¼š</strong>`;
                    
                    // æ‰¾å‡ºé£é™©è¡Œä¸ºæœ€é«˜çš„æƒ…å¢ƒ
                    const behaviorStats = completedScenarios.map(scenario => {
                        const data = allExperimentData.filter(d => d.scenario === scenario);
                        const successTrials = data.filter(d => d.outcome === 'cash_out');
                        const avgLevel = successTrials.length > 0 ? 
                            successTrials.reduce((sum, d) => sum + d.final_risk_level, 0) / successTrials.length : 0;
                        return { scenario, avgLevel };
                    });
                    
                    const maxRiskScenario = behaviorStats.reduce((max, s) => s.avgLevel > max.avgLevel ? s : max);
                    const scenarioNames = {'PTC': 'åŒ»ç–—æƒ…å¢ƒ', 'WRRD': 'ç¤¾ä¼šæƒ…å¢ƒ', 'MID': 'ç»æµæƒ…å¢ƒ'};
                    
                    analysis += `åŸºäºæ‚¨çš„è¡Œä¸ºæ•°æ®å’Œè®¤çŸ¥å‚æ•°ï¼Œæ‚¨åœ¨<span style="color: #1976d2; font-weight: bold;">${scenarioNames[maxRiskScenario.scenario]}</span>ä¸­è¡¨ç°å‡ºæœ€é«˜çš„é£é™©æ‰¿æ‹…è¡Œä¸ºï¼Œè¿™å¯èƒ½æ˜¯å…ˆéªŒä¿¡å¿µã€é£é™©åå¥½å’Œæƒ…å¢ƒç‰¹å¾å…±åŒä½œç”¨çš„ç»“æœã€‚</p>`;
                }
            } else {
                analysis += `
                    <p><strong>åŸºäºè¡Œä¸ºæ•°æ®çš„åˆ†æï¼š</strong>è™½ç„¶è´å¶æ–¯å‚æ•°åˆ†ææœªå®Œå…¨å®Œæˆï¼Œä½†åŸºäºæ‚¨çš„å†³ç­–è¡Œä¸ºæ•°æ®ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥çœ‹å‡ºæ‚¨åœ¨ä¸åŒæƒ…å¢ƒä¸‹çš„é£é™©å†³ç­–æ¨¡å¼å­˜åœ¨å·®å¼‚ã€‚</p>
                    <p>å®Œæ•´çš„è´å¶æ–¯å‚æ•°åˆ†æéœ€è¦æ›´å¤æ‚çš„è®¡ç®—èµ„æºï¼Œå»ºè®®å°†æ•°æ®å¯¼å‡ºåä½¿ç”¨ä¸“ä¸šå·¥å…·è¿›è¡Œæ·±å…¥åˆ†æã€‚</p>
                `;
            }
            
            analysis += '</div>';
            return analysis;
        }
        
        // ä¸‹è½½å®Œæ•´æ•°æ®
        function downloadAllData() {
            const allData = {
                participant_info: {
                    participant_id: participantId,
                    experiment_date: new Date().toISOString(),
                    scenario_order: completedScenarios,
                    trials_per_scenario: TRIALS_PER_SCENARIO,
                    total_expected_trials: TRIALS_PER_SCENARIO * 3,
                    total_recorded_trials: allExperimentData.length,
                    scenario_points: scenarioPoints,
                    experiment_version: 'Bayesian_4_Parameter_Analysis_Fixed'
                },
                behavioral_data: allExperimentData,
                bayesian_data: bayesianData
            };
            
            const jsonContent = JSON.stringify(allData, null, 2);
            downloadFile(jsonContent, `CrossSituational_RiskDecision_Complete_${participantId}_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
            
            // åŒæ—¶ä¸‹è½½CSVæ ¼å¼çš„è¡Œä¸ºæ•°æ®
            const csvHeaders = [
                'participant_id', 'scenario', 'trial', 'outcome', 'final_risk_level', 
                'locked_points', 'lost_points', 'trial_duration', 'actions', 'risk_probabilities', 'timestamp'
            ];
            const csvContent = [
                csvHeaders.join(','),
                ...allExperimentData.map(row => 
                    csvHeaders.map(header => {
                        if (header === 'actions' || header === 'risk_probabilities') {
                            return `"${JSON.stringify(row[header]).replace(/"/g, '""')}"`;
                        }
                        return row[header] || '';
                    }).join(',')
                )
            ].join('\n');
            
            downloadFile(csvContent, `CrossSituational_RiskDecision_Behavioral_${participantId}_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
        }
        
        // ä¸‹è½½è´å¶æ–¯åˆ†æç»“æœ
        function downloadBayesianResults() {
            const bayesianResults = {
                participant_id: participantId,
                analysis_date: new Date().toISOString(),
                model_info: {
                    model_type: 'Bayesian_4_Parameter_BART',
                    parameters: ['phi', 'eta', 'gamma', 'beta'],
                    parameter_meanings: {
                        phi: 'Prior belief about balloon not bursting',
                        eta: 'Learning rate',
                        gamma: 'Risk preference',
                        beta: 'Behavioral consistency'
                    }
                },
                scenario_results: {}
            };
            
            // æ·»åŠ æ¯ä¸ªæƒ…å¢ƒçš„è´å¶æ–¯ç»“æœ
            completedScenarios.forEach(scenario => {
                const results = bayesianData[scenario + '_results'];
                if (results) {
                    bayesianResults.scenario_results[scenario] = {
                        parameters: results.parameters,
                        interpretation: results.interpretation,
                        model_fit: {
                            log_likelihood: results.logLikelihood,
                            converged: results.converged
                        }
                    };
                }
            });
            
            const jsonContent = JSON.stringify(bayesianResults, null, 2);
            downloadFile(jsonContent, `Bayesian_Analysis_Results_${participantId}_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
            
            // åˆ›å»ºç®€åŒ–çš„CSVæ ¼å¼
            const csvHeaders = ['scenario', 'phi', 'eta', 'gamma', 'beta', 'phi_level', 'eta_level', 'gamma_level', 'beta_level', 'log_likelihood'];
            const csvRows = completedScenarios.map(scenario => {
                const results = bayesianData[scenario + '_results'];
                if (results && results.parameters) {
                    const { phi, eta, gamma, beta } = results.parameters;
                    const interp = results.interpretation;
                    return [
                        scenario,
                        phi.toFixed(4),
                        eta.toFixed(4),
                        gamma.toFixed(4),
                        beta.toFixed(4),
                        interp.phi.level,
                        interp.eta.level,
                        interp.gamma.level,
                        interp.beta.level,
                        results.logLikelihood.toFixed(4)
                    ].join(',');
                }
                return `${scenario},,,,,,,,,`;
            });
            
            const csvContent = [csvHeaders.join(','), ...csvRows].join('\n');
            downloadFile(csvContent, `Bayesian_Parameters_${participantId}_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
        }
        
        // ä¸‹è½½ç»¼åˆåˆ†ææŠ¥å‘Š
        function downloadSummaryReport() {
            const ptcData = allExperimentData.filter(d => d.scenario === 'PTC');
            const wrrdData = allExperimentData.filter(d => d.scenario === 'WRRD');
            const midData = allExperimentData.filter(d => d.scenario === 'MID');
            
            const summary = {
                participant_id: participantId,
                experiment_date: new Date().toISOString(),
                trials_per_scenario: TRIALS_PER_SCENARIO,
                expected_total_trials: TRIALS_PER_SCENARIO * 3,
                actual_total_trials: allExperimentData.length,
                data_completeness: (allExperimentData.length / (TRIALS_PER_SCENARIO * 3) * 100).toFixed(1) + '%',
                
                // åŒ»ç–—æƒ…å¢ƒæ•°æ®
                ptc_recorded_trials: ptcData.length,
                ptc_avg_final_level: ptcData.filter(d => d.outcome === 'cash_out').length > 0 ?
                    (ptcData.filter(d => d.outcome === 'cash_out').reduce((sum, d) => sum + d.final_risk_level, 0) / ptcData.filter(d => d.outcome === 'cash_out').length).toFixed(2) : 0,
                ptc_explosion_rate: ((ptcData.filter(d => d.outcome === 'explosion').length / ptcData.length) * 100).toFixed(1),
                ptc_total_locked: scenarioPoints.PTC,
                
                // ç¤¾ä¼šæƒ…å¢ƒæ•°æ®
                wrrd_recorded_trials: wrrdData.length,
                wrrd_avg_final_level: wrrdData.filter(d => d.outcome === 'cash_out').length > 0 ?
                    (wrrdData.filter(d => d.outcome === 'cash_out').reduce((sum, d) => sum + d.final_risk_level, 0) / wrrdData.filter(d => d.outcome === 'cash_out').length).toFixed(2) : 0,
                wrrd_explosion_rate: ((wrrdData.filter(d => d.outcome === 'explosion').length / wrrdData.length) * 100).toFixed(1),
                wrrd_total_locked: scenarioPoints.WRRD,
                
                // ç»æµæƒ…å¢ƒæ•°æ®
                mid_recorded_trials: midData.length,
                mid_avg_final_level: midData.filter(d => d.outcome === 'cash_out').length > 0 ?
                    (midData.filter(d => d.outcome === 'cash_out').reduce((sum, d) => sum + d.final_risk_level, 0) / midData.filter(d => d.outcome === 'cash_out').length).toFixed(2) : 0,
                mid_explosion_rate: ((midData.filter(d => d.outcome === 'explosion').length / midData.length) * 100).toFixed(1),
                mid_total_locked: scenarioPoints.MID,
                
                // è·¨æƒ…å¢ƒæ¯”è¾ƒ
                most_risk_taking_scenario: [
                    ['PTC', parseFloat(ptcData.filter(d => d.outcome === 'cash_out').length > 0 ? (ptcData.filter(d => d.outcome === 'cash_out').reduce((sum, d) => sum + d.final_risk_level, 0) / ptcData.filter(d => d.outcome === 'cash_out').length) : 0)],
                    ['WRRD', parseFloat(wrrdData.filter(d => d.outcome === 'cash_out').length > 0 ? (wrrdData.filter(d => d.outcome === 'cash_out').reduce((sum, d) => sum + d.final_risk_level, 0) / wrrdData.filter(d => d.outcome === 'cash_out').length) : 0)],
                    ['MID', parseFloat(midData.filter(d => d.outcome === 'cash_out').length > 0 ? (midData.filter(d => d.outcome === 'cash_out').reduce((sum, d) => sum + d.final_risk_level, 0) / midData.filter(d => d.outcome === 'cash_out').length) : 0)]
                ].sort((a, b) => b[1] - a[1])[0][0],
                
                scenario_completion_order: completedScenarios,
                
                total_points: scenarioPoints.PTC + scenarioPoints.WRRD + scenarioPoints.MID,
                separate_scenario_points: scenarioPoints,
                
                // æ·»åŠ è´å¶æ–¯å‚æ•°æ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
                bayesian_summary: {}
            };
            
            // æ·»åŠ è´å¶æ–¯å‚æ•°æ‘˜è¦
            completedScenarios.forEach(scenario => {
                const results = bayesianData[scenario + '_results'];
                if (results && results.parameters) {
                    summary.bayesian_summary[scenario] = {
                        phi: results.parameters.phi,
                        eta: results.parameters.eta,
                        gamma: results.parameters.gamma,
                        beta: results.parameters.beta,
                        phi_interpretation: results.interpretation.phi.meaning,
                        gamma_interpretation: results.interpretation.gamma.meaning
                    };
                }
            });
            
            const csvContent = [
                Object.keys(summary).join(','),
                Object.values(summary).map(v => typeof v === 'object' ? JSON.stringify(v) : v).join(',')
            ].join('\n');
            
            downloadFile(csvContent, `CrossSituational_Summary_Report_${participantId}_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
        }
        
        // æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }
        
        // åˆå§‹åŒ–å®éªŒ
        function initializeExperiment() {
            updateLoadingStatus('åˆå§‹åŒ–å®éªŒ...');
            
            try {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('jspsych-target').style.display = 'block';
                
                const jsPsych = initJsPsych({
                    display_element: 'jspsych-target',
                    on_finish: function() {
                        // å®éªŒå®Œæˆ
                    }
                });

                const mainInstructions = {
                    type: jsPsychInstructions,
                    pages: [
                        `<div style="max-width: 900px; margin: 0 auto; padding: 30px; text-align: center;">
                            <h1 style="color: #1976d2;">è·¨æƒ…å¢ƒé£é™©å†³ç­–çš„ä¸ªæ€§åŒ–åŠ¨æ€è¯„ä¼°æµ‹éªŒ</h1>
                            <h2 style="color: #9c27b0;">è´å¶æ–¯å››å‚æ•°åˆ†æç‰ˆ</h2>
                            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 30px; border-radius: 15px; margin: 30px 0;">
                                <h2>æ¬¢è¿å‚ä¸æœ¬ç ”ç©¶ï¼</h2>
                                <p style="font-size: 18px; line-height: 1.8;">
                                    æœ¬æµ‹éªŒæ—¨åœ¨äº†è§£æ‚¨åœ¨ä¸åŒæƒ…å¢ƒä¸‹çš„é£é™©å†³ç­–åå¥½ã€‚<br>
                                    æ‚¨å°†ä¾æ¬¡ä½“éªŒ<strong>åŒ»ç–—ã€ç¤¾ä¼šã€ç»æµ</strong>ä¸‰ä¸ªä¸åŒçš„å†³ç­–æƒ…å¢ƒã€‚<br>
                                    <span style="color: #9c27b0; font-weight: bold;">å®Œæˆåå°†è¿›è¡Œè´å¶æ–¯å››å‚æ•°åˆ†æï¼Œæ·±å…¥è§£ææ‚¨çš„ä¸ªæ€§åŒ–å†³ç­–æ¨¡å¼ã€‚</span>
                                </p>
                            </div>
                        </div>`,
                        
                        `<div style="max-width: 900px; margin: 0 auto; padding: 30px;">
                            <h2 style="color: #1976d2; text-align: center;">æµ‹éªŒæ¦‚å†µä¸ç‰¹è‰²</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin: 30px 0;">
                                <div style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9); padding: 25px; border-radius: 15px; text-align: center;">
                                    <h3 style="color: #2e7d32;">ğŸ¥ åŒ»ç–—æƒ…å¢ƒ</h3>
                                    <p>æ¨¡æ‹Ÿæ‚¨ä¸ºè‡ªå·±é€‰æ‹©æ²»ç–—æ–¹æ¡ˆå¼ºåº¦çš„å†³ç­–è¿‡ç¨‹</p>
                                    <p><strong>æ”¶ç›Šï¼š</strong>å¥åº·æ”¹å–„ç‚¹æ•°</p>
                                    <p><strong>é£é™©ï¼š</strong>è¯ç‰©å‰¯ä½œç”¨</p>
                                    <p><small>50ä¸ªç‹¬ç«‹è¯•æ¬¡</small></p>
                                </div>
                                <div style="background: linear-gradient(135deg, #fff3e0, #ffcc80); padding: 25px; border-radius: 15px; text-align: center;">
                                    <h3 style="color: #ef6c00;">âš”ï¸ ç¤¾ä¼šæƒ…å¢ƒ</h3>
                                    <p>æ¨¡æ‹Ÿæˆ˜æ—¶å®˜å‘˜è¿›è¡Œèµ„æºå¾æ”¶çš„å†³ç­–è¿‡ç¨‹</p>
                                    <p><strong>æ”¶ç›Šï¼š</strong>å†›äº‹å‚¨å¤‡ç‚¹æ•°</p>
                                    <p><strong>é£é™©ï¼š</strong>æ°‘ä¼—æš´åŠ¨</p>
                                    <p><small>50ä¸ªç‹¬ç«‹è¯•æ¬¡</small></p>
                                </div>
                                <div style="background: linear-gradient(135deg, #e3f2fd, #90caf9); padding: 25px; border-radius: 15px; text-align: center;">
                                    <h3 style="color: #1565c0;">ğŸ’° ç»æµæƒ…å¢ƒ</h3>
                                    <p>æ¨¡æ‹Ÿæ‚¨è¿›è¡ŒæŠ•èµ„åŠ ä»“çš„å†³ç­–è¿‡ç¨‹</p>
                                    <p><strong>æ”¶ç›Šï¼š</strong>é¢„ä¼°åˆ©æ¶¦ç‚¹æ•°</p>
                                    <p><strong>é£é™©ï¼š</strong>èµ„äº§å´©ç›˜</p>
                                    <p><small>50ä¸ªç‹¬ç«‹è¯•æ¬¡</small></p>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f3e5f5, #e1f5fe); padding: 25px; border-radius: 15px; margin: 30px 0; border: 3px solid #9c27b0;">
                                <h3 style="color: #9c27b0; text-align: center;">ğŸ§  è´å¶æ–¯å››å‚æ•°è®¤çŸ¥å»ºæ¨¡</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                                        <div style="font-size: 20px; margin-bottom: 5px;">Î¦</div>
                                        <div style="font-size: 14px; font-weight: bold;">å…ˆéªŒä¿¡å¿µ</div>
                                        <div style="font-size: 12px; color: #666;">å¯¹é£é™©çš„åˆå§‹åˆ¤æ–­</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                                        <div style="font-size: 20px; margin-bottom: 5px;">Î·</div>
                                        <div style="font-size: 14px; font-weight: bold;">å­¦ä¹ ç‡</div>
                                        <div style="font-size: 12px; color: #666;">æ ¹æ®åé¦ˆè°ƒæ•´é€Ÿåº¦</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                                        <div style="font-size: 20px; margin-bottom: 5px;">Î³</div>
                                        <div style="font-size: 14px; font-weight: bold;">é£é™©åå¥½</div>
                                        <div style="font-size: 12px; color: #666;">è¿½æ±‚æ”¶ç›Šçš„æ„æ„¿</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                                        <div style="font-size: 20px; margin-bottom: 5px;">Î²</div>
                                        <div style="font-size: 14px; font-weight: bold;">å†³ç­–ä¸€è‡´æ€§</div>
                                        <div style="font-size: 12px; color: #666;">è¡Œä¸ºçš„ç†æ€§ç¨‹åº¦</div>
                                    </div>
                                </div>
                            </div>
                        </div>`,
                        
                        `<div style="max-width: 900px; margin: 0 auto; padding: 30px;">
                            <h2 style="color: #1976d2; text-align: center;">é‡è¦æé†’</h2>
                            <div style="background: #fff3cd; padding: 25px; border-radius: 15px; margin: 25px 0; border: 3px solid #ffc107;">
                                <h3>ğŸ“‹ æµ‹éªŒæµç¨‹ï¼š</h3>
                                <ul style="text-align: left; font-size: 16px; line-height: 1.8;">
                                    <li>æ¯ä¸ªæƒ…å¢ƒåŒ…å«<strong>${TRIALS_PER_SCENARIO}è½®ç‹¬ç«‹å†³ç­–</strong>ï¼ˆè¾ƒå……è¶³çš„æ•°æ®é‡ç¡®ä¿åˆ†æå‡†ç¡®æ€§ï¼‰</li>
                                    <li>æ¯è½®æ‚¨å¯ä»¥å¤šæ¬¡é€‰æ‹©"å¢åŠ é£é™©"æˆ–"å®‰å…¨å…‘ç°"</li>
                                    <li>é£é™©è¶Šé«˜ï¼Œæ½œåœ¨æ”¶ç›Šè¶Šå¤§ï¼Œä½†è´Ÿé¢ç»“æœæ¦‚ç‡ä¹Ÿè¶Šé«˜</li>
                                    <li>å®Œæˆæ¯ä¸ªæƒ…å¢ƒåï¼Œå°†ç«‹å³è¿›è¡Œè´å¶æ–¯å‚æ•°åˆ†æ</li>
                                    <li>å®Œæˆä¸‰ä¸ªæƒ…å¢ƒåï¼Œå°†è·å¾—ç»¼åˆçš„è·¨æƒ…å¢ƒåˆ†ææŠ¥å‘Š</li>
                                </ul>
                                
                                <h3>ğŸ§  æ•°æ®åˆ†æç‰¹è‰²ï¼š</h3>
                                <ul style="text-align: left; font-size: 16px; line-height: 1.8;">
                                    <li><strong>å®Œæ•´è®°å½•æ‰€æœ‰è¯•æ¬¡ï¼š</strong>ç¡®ä¿æ¯ä¸ªè¯•æ¬¡éƒ½è¢«è®°å½•ï¼Œä¿è¯150æ¬¡å®Œæ•´æ•°æ®</li>
                                    <li><strong>å„æƒ…å¢ƒç‹¬ç«‹è®¡åˆ†ï¼š</strong>åŒ»ç–—ã€ç¤¾ä¼šã€ç»æµæƒ…å¢ƒåˆ†åˆ«è®¡ç®—ç´¯è®¡ç‚¹æ•°</li>
                                    <li><strong>å®æ—¶è´å¶æ–¯åˆ†æï¼š</strong>ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œå‚æ•°ä¼°è®¡ï¼Œæ— éœ€é¢å¤–è½¯ä»¶</li>
                                    <li><strong>ä¸ªæ€§åŒ–è§£è¯»ï¼š</strong>åŸºäºå››ä¸ªæ ¸å¿ƒå‚æ•°æ·±å…¥åˆ†ææ‚¨çš„å†³ç­–æ¨¡å¼</li>
                                    <li><strong>è·¨æƒ…å¢ƒæ¯”è¾ƒï¼š</strong>æ­ç¤ºæ‚¨åœ¨ä¸åŒæƒ…å¢ƒä¸‹çš„è®¤çŸ¥å·®å¼‚</li>
                                </ul>
                                
                                <h3>ğŸ’° æŠ¥é…¬æœºåˆ¶ï¼š</h3>
                                <p style="font-size: 16px; text-align: center;">
                                    æ‚¨çš„æµ‹éªŒè¡¨ç°å°†è½¬åŒ–ä¸º<strong>é¢å¤–çš„å®éªŒæŠ¥é…¬</strong>
                                </p>
                                
                                <h3>ğŸ”’ ä¼¦ç†å£°æ˜ï¼š</h3>
                                <p style="font-size: 14px; color: #666; text-align: center;">
                                    æ‰€æœ‰æƒ…å¢ƒå‡ä¸ºæ¨¡æ‹Ÿå†³ç­–ç ”ç©¶ï¼ŒéçœŸå®å»ºè®®ã€‚æ•°æ®ä»…ç”¨äºç§‘å­¦ç ”ç©¶ï¼Œæ‚¨å¯éšæ—¶é€€å‡ºã€‚
                                </p>
                            </div>
                        </div>`
                    ],
                    show_clickable_nav: true,
                    button_label_previous: 'ä¸Šä¸€é¡µ',
                    button_label_next: 'ä¸‹ä¸€é¡µ',
                    button_label_finish: 'å¼€å§‹æµ‹éªŒ',
                    on_finish: function() {
                        showScenarioSelection();
                    }
                };

                jsPsych.run([mainInstructions]);
                
            } catch (error) {
                console.error('å®éªŒåˆå§‹åŒ–å¤±è´¥:', error);
                showError(`å®éªŒåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ä¾èµ–
        document.addEventListener('DOMContentLoaded', function() {
            updateLoadingStatus('æ£€æŸ¥å®éªŒä¾èµ–...');
            setTimeout(checkLibrariesLoaded, 1000);
        });
        
        if (document.readyState !== 'loading') {
            setTimeout(checkLibrariesLoaded, 1000);
        }
    </script>
</body>
</html>
